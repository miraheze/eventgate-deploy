{"version":3,"sources":["../src/index.ts","../src/logging/index.ts","../src/logging/wikimedia_ecs.ts","../src/metric/prometheus.ts","../src/metric/metric.ts","../src/metric/index.ts","../src/metric/prometheus_server.ts","../src/express.ts","../src/trace.ts","../src/open_telemetry.ts"],"sourcesContent":["import path from 'node:path';\nimport yargs from 'yargs';\nimport { hideBin } from 'yargs/helpers';\nimport { loadConfig } from 'c12';\n\nimport type winston from 'winston';\nimport {\n\tWinstonLoggerOptions,\n\tcreateWinstonLogger\n} from './logging/index.ts';\n\nimport Prometheus from 'prom-client';\nimport { Metrics, type MetricType } from './metric/index.ts';\nimport type { MetricTypeEnum } from './metric/metric.ts';\nimport PrometheusServer, { PrometheusMetricsConfig } from './metric/prometheus_server.ts';\n\nimport { wrapRouteHandlers, prefixRouterPathMiddleware, responseTimeMetricsMiddleware } from './express.ts';\nimport { extractTraceContext } from './trace.ts';\nimport { XRequestPropagator } from './open_telemetry.ts';\n\nconst _yargs = ( ...args: Parameters<typeof yargs> ) =>\n// Defaults that are described are infered from c12 and not a `default` property\n\tyargs( ...args )\n\t\t.usage( 'Usage: $0 [command] [options]' )\n\t\t.options( {\n\t\t\t'config-directory': {\n\t\t\t\talias: 'd',\n\t\t\t\tdescribe: 'Absolute or relative path of the config file. Defaults to cwd',\n\t\t\t\ttype: 'string',\n\t\t\t\tnargs: 1,\n\t\t\t\tglobal: true\n\t\t\t},\n\t\t\t'config-file': {\n\t\t\t\talias: 'f',\n\t\t\t\tdescribe:\n          'Name of the config file with or without the extension. Defaults to service-utils.config`',\n\t\t\t\ttype: 'string',\n\t\t\t\tnargs: 1,\n\t\t\t\tglobal: true\n\t\t\t},\n\t\t\tconfig: {\n\t\t\t\talias: 'c',\n\t\t\t\tdescribe:\n          'Absolute or relative path of the config file with or without extension. Defaults to ${cwd}/service-utils.config',\n\t\t\t\ttype: 'string',\n\t\t\t\tnargs: 1,\n\t\t\t\tglobal: true\n\t\t\t}\n\t\t} )\n\t\t.help( 'h' )\n\t\t.alias( 'h', 'help' );\n\n// Call function at top level to support --help\n// However, we will call this again in ServiceUtils.loadConfig to support tests\n_yargs( hideBin( process.argv ) ).parseSync();\n\ninterface _Config {\n\tservice_name?: string;\n\tlogging?: WinstonLoggerOptions;\n\tmetrics?: PrometheusMetricsConfig;\n\t[key: string]: any;\n}\n\n// Allow generic typing of arbitrary key/values\ntype Config<T extends Record<string, any>> = _Config & T;\n\nexport class ServiceUtils<T extends Record<string, any> = object> {\n\tconfig: Config<T>;\n\n\tlogger: winston.Logger;\n\n\tmetrics: Metrics;\n\n\tprometheusServer?: PrometheusServer;\n\n\t/**\n\t * Creates the logger, metrics, and prometheus metrics endpoint\n\t *\n\t * @param config\n\t */\n\tconstructor( config: Config<T> ) {\n\t\tthis.config = config;\n\t\tthis.logger = ServiceUtils.createLogger( config );\n\n\t\t// Backwards compatibility for array of metrics config\n\t\tif ( config.metrics instanceof Array ) {\n\t\t\tconfig.metrics = config.metrics[ 0 ];\n\t\t}\n\n\t\tif ( config.metrics ) {\n\t\t\tthis.prometheusServer = ServiceUtils.createPrometheusServer(\n\t\t\t\tconfig.metrics as PrometheusMetricsConfig,\n\t\t\t\t{ service: config.service_name ?? 'default_service' }\n\t\t\t);\n\t\t}\n\t\tthis.metrics = ServiceUtils.createMetrics( config, this.logger );\n\t}\n\n\tstatic createPrometheusServer( prometheus_config: PrometheusMetricsConfig, defaultLabels: Record<string, string> ) {\n\t\treturn new PrometheusServer( prometheus_config, defaultLabels );\n\t}\n\n\tstatic createLogger( config: Config<Record<string, any>> ) {\n\t\treturn createWinstonLogger(\n\t\t\tconfig.service_name ?? 'default_service',\n\t\t\tconfig.logging as WinstonLoggerOptions\n\t\t);\n\t}\n\n\tstatic createMetrics( config: Config<Record<string, any>>, logger: winston.Logger ) {\n\t\treturn new Metrics(\n\t\t\tconfig.service_name ?? 'default_service',\n\t\t\tlogger,\n\t\t\tconfig.metrics\n\t\t);\n\t}\n\n\tasync teardown() {\n\t\tif ( this.prometheusServer ) {\n\t\t\tawait this.prometheusServer.close();\n\t\t}\n\t}\n\n\t/**\n\t * @param {Object=} options c12 loadConfig configuration\n\t * @param {Object=} options.defaultConfig Default config overrideable from yaml\n\t * @param {string=} options.envName Environment-conditional to load\n\t * @param {string=} options.configDirectory Default config directory overrideable in cli. Overrides c12's options.cwd\n\t * @param {string=} options.configFile Name of the config file (without extension) overrideable in cli. Defaults to service-utils.config\n\t * @return\n\t */\n\tstatic async loadConfig<T extends Record<string, any>>(\n\t\toptions?: Parameters<typeof loadConfig<Config<T>>>[0] & {\n\t\t\tuseArgs?: boolean,\n\t\t\tconfigDirectory?: string\n\t\t}\n\t) {\n\t\tconst parsedArgs = _yargs( hideBin( process.argv ) ).parseSync();\n\n\t\tlet configDirectory: string | undefined;\n\t\tlet configFile: string | undefined;\n\n\t\tif ( options?.useArgs !== false ) {\n\t\t\t// -c arg\n\t\t\tif ( parsedArgs.config ) {\n\t\t\t\tconst configPath = path.parse( parsedArgs.config );\n\t\t\t\tconfigDirectory = configPath.dir;\n\t\t\t\tconfigFile = configPath.name;\n\t\t\t}\n\n\t\t\t// TODO: Should these take precedence over -c?\n\t\t\t// -f arg\n\t\t\tconfigFile ??= parsedArgs.configFile ?? options?.configFile;\n\t\t\t// -d arg\n\t\t\tconfigDirectory ??= parsedArgs.configDirectory ?? options?.configDirectory ?? options?.cwd;\n\t\t\tif ( configDirectory && !/^\\//.test( configDirectory ) ) {\n\t\t\t\t// resolve relative paths\n\t\t\t\tconfigDirectory = path.resolve(\n\t\t\t\t\t`${ process.cwd() }/${ configDirectory ?? '' }`\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\tconst loadedConfig = await loadConfig<Config<T>>( {\n\t\t\tname: 'service-utils',\n\t\t\t...options,\n\t\t\t...{\n\t\t\t\tcwd: configDirectory,\n\t\t\t\tconfigFile: configFile\n\t\t\t}\n\t\t} );\n\n\t\treturn loadedConfig.config as Config<T>;\n\t}\n}\n\nexport { MetricType, MetricTypeEnum };\nlet singleton: ServiceUtils | undefined;\n\n/**\n * @param {Object=} options c12 loadConfig configuration\n * @param {Object=} options.defaultConfig Default config overrideable from yaml\n * @param {string=} options.envName Environment-conditional to load\n * @param {string=} options.configDirectory Default config directory overrideable in cli\n * @param {string=} options.configFile Name of the config file (with or without extension) overrideable in cli. Defaults to service-utils.config\n * @param {false=} options.startPrometheusServer Starts Prometheus server if not set to false\n * @param {true=} options.useArgs Use yaml config fetched from cli args to override config if not set to false. Useful for testing.\n * @return {ServiceUtils}\n */\nexport const getInstance = async <T extends Record<string, unknown>>(\n\toptions?: Parameters<typeof loadConfig<Config<T>>>[0] & {\n\t\tstartPrometheusServer?: boolean;\n\t\tuseArgs?: boolean;\n\t}\n): Promise<ServiceUtils<T>> => {\n\tif ( singleton === undefined ) {\n\t\tconst loadedConfig = await ServiceUtils.loadConfig<T>( options );\n\t\tsingleton = new ServiceUtils<T>( loadedConfig );\n\t\tif ( options?.startPrometheusServer !== false && singleton.prometheusServer ) {\n\t\t\tsingleton.prometheusServer.start();\n\t\t}\n\t}\n\treturn singleton as ServiceUtils<T>;\n};\n\nexport const teardown = async () => {\n\tif ( singleton !== undefined ) {\n\t\tawait singleton.teardown();\n\t\tsingleton = undefined;\n\t}\n};\n\nexport const helpers = {\n\twrapExpressRouteHandlers: wrapRouteHandlers,\n\tprefixRouterPathMiddleware,\n\textractTraceContext,\n\tresponseTimeMetricsMiddleware,\n\tXRequestPropagator\n};\n\nexport const prometheus = Prometheus;\n","import winston from 'winston';\nimport { ecsFields, ecsStringify } from '@elastic/ecs-winston-format';\nimport { wikimediaEcsFormatMiddleware } from './wikimedia_ecs.ts';\n\n// npm default log levels, with additional ones to support bunyan.\n// 'trace' and 'fatal' are from bunyan and not natively supported by winston.\n// If these are used, they are shifted to the nearest supported log level\nconst logLevels = {\n\tfatal: 0,\n\terror: 0,\n\twarn: 1,\n\tinfo: 2,\n\thttp: 3,\n\tverbose: 4,\n\tdebug: 5,\n\ttrace: 5,\n\tsilly: 6\n};\n\nexport type Level = keyof typeof logLevels;\n\n/**\n * Configurable and serializable Winston logger options\n * to be derived into its associated objects with {@link createWinstonLogger}\n */\nexport interface WinstonLoggerOptions {\n\tlevel?: Level;\n\tstacktrace?: boolean;\n\tformat?: keyof typeof winston.format | 'ecs';\n\tformatOptions?: any;\n\ttransports?: Array<{\n\t\ttransport: 'File' | 'Console' | 'Http' | 'Stream';\n\t\toptions?: {\n\t\t\tformat?: keyof typeof winston.format | 'ecs';\n\t\t\t[key: string]: any;\n\t\t};\n\t}>;\n\tdefaultMeta?: { [key: string]: any; };\n}\n\n/**\n * @param serviceName Name of the service. Added to default metadata of the logger.\n * @param options {@link WinstonLoggerOptions}, not to be confused with {@link winston.LoggerOptions}\n * @return\n */\nexport const createWinstonLogger = (\n\tserviceName: string,\n\toptions: WinstonLoggerOptions = {}\n) => {\n\t// Uses spread operator to fill options\n\t// with defaults first and then override with config\n\toptions = {\n\t\t...{\n\t\t\tlevel: 'info',\n\t\t\tstacktrace: true,\n\t\t\tformat: 'ecs',\n\t\t\ttransports: [ { transport: 'Console' } ]\n\t\t},\n\t\t...options\n\t};\n\n\tconst ecsFormatter = [\n\t\tecsFields( { convertReqRes: true, ...options.formatOptions } ),\n\t\twikimediaEcsFormatMiddleware(),\n\t\tecsStringify()\n\t];\n\n\treturn winston.createLogger( {\n\t\tlevels: logLevels,\n\t\tlevel: options.level,\n\t\tformat: winston.format.combine(\n\t\t\t...[// Enable stacktrace for errors\n\t\t\t\twinston.format.errors( { stack: options.stacktrace } ),\n\t\t\t\toptions.format === 'ecs' ?\n\t\t\t\t\tecsFormatter :\n\t\t\t\t\twinston.format[ options.format ?? 'json' ](\n\t\t\t\t\t\toptions.format ? options.formatOptions : undefined\n\t\t\t\t\t) ].flat()\n\t\t),\n\t\tdefaultMeta: {\n\t\t\tservice: {\n\t\t\t\tname: serviceName\n\t\t\t},\n\t\t\t...options.defaultMeta\n\t\t},\n\t\ttransports: ( options.transports ?? [] ).map(\n\t\t\t( { transport, options: transportOptions } ) =>\n\t\t\t// @ts-ignore\n\t\t\t\tnew winston.transports[ transport ]( {\n\t\t\t\t\t...transportOptions,\n\t\t\t\t\t// Spread format seperately so we can add on options as parameters\n\t\t\t\t\t...( transportOptions?.format ?\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tformat: winston.format.combine(\n\t\t\t\t\t\t\t\t...[ winston.format.errors( { stack: options.stacktrace } ),\n\t\t\t\t\t\t\t\t\ttransportOptions.format === 'ecs' ?\n\t\t\t\t\t\t\t\t\t\tecsFormatter :\n\t\t\t\t\t\t\t\t\t\twinston.format[ transportOptions.format ](\n\t\t\t\t\t\t\t\t\t\t\ttransportOptions.formatOptions\n\t\t\t\t\t\t\t\t\t\t) ].flat()\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t} :\n\t\t\t\t\t\t{} )\n\t\t\t\t} )\n\n\t\t)\n\t} );\n};\n","// logform and triple-beam are transitive dependencies of winston\nimport type { TransformableInfo, Format } from 'logform';\nimport { LEVEL, MESSAGE, SPLAT } from 'triple-beam';\n// defu is a transitive dependency of c12\nimport { defu } from 'defu';\n\n// (incomplete) ECS fragments derived from https://docs.wikimedia.org/ecs\n// Only the keys used in the code are listed here.\ninterface Http {\n\trequest?: {\n\t\tbody?: {\n\t\t\tcontent?: unknown\n\t\t},\n\t\tid?: string,\n\t\t[key: string]: unknown\n\t},\n\tresponse?: {\n\t\t[key: string]: unknown\n\t},\n\t[key: string]: unknown\n}\n\ninterface Url {\n\tfull?: string,\n\tpath?: string,\n\tquery?: string,\n\t[key: string]: unknown\n}\n\ninterface Source {\n\tip?: string,\n\tport?: number,\n\t[key: string]: unknown\n}\n\ninterface RequestData {\n\tremoteAddress?: string,\n\tremotePort?: number,\n\turl?: string,\n\tpath?: string,\n\tparams?: string[],\n\t[key: string]: unknown\n}\n\ninterface ResponseData {\n\t[key: string]: unknown\n}\n\n/**\n * A Winston `Format` for converting fields from the legacy bunyan structure\n * that was passed into Winston's ecs formatter into the standard fields\n * that Wikimedia uses.\n * Must be inserted betwwen ecsFields() and ecsStringify().\n *\n * @class {Format}\n * @param {Config} opts\n */\nclass WikimediaEcsFormatMiddleware implements Format {\n\ttransform( info: TransformableInfo ): TransformableInfo {\n\t\t// Process service name transformation\n\t\tconst serviceInfo = this.processServiceName( info );\n\n\t\t// Process HTTP request/response data\n\t\tconst httpInfo = this.processHttpData( serviceInfo );\n\n\t\t// Process request ID\n\t\tconst requestIdInfo = this.processRequestId( httpInfo );\n\n\t\t// Ensure symbols are preserved\n\t\trequestIdInfo[ LEVEL ] = info[ LEVEL ];\n\t\trequestIdInfo[ MESSAGE ] = info[ MESSAGE ];\n\t\trequestIdInfo[ SPLAT ] = info[ SPLAT ];\n\n\t\treturn requestIdInfo;\n\t}\n\n\t/**\n\t * Handles service name transformation from legacy bunyan structure\n\t *\n\t * @param info\n\t */\n\tprivate processServiceName( info: TransformableInfo ): TransformableInfo {\n\t\tif ( !info.serviceName && !( info.service && typeof info.service !== 'object' ) ) {\n\t\t\treturn info;\n\t\t}\n\n\t\tconst serviceName = info.serviceName ?? info.service;\n\t\tconst updatedInfo = { ...info };\n\n\t\tupdatedInfo.service = { name: serviceName };\n\t\tdelete updatedInfo.serviceName;\n\n\t\treturn updatedInfo;\n\t}\n\n\t/**\n\t * Processes HTTP request and response data into ECS format\n\t * See https://github.com/wikimedia/service-template-node/blob/main/lib/util.js#L45\n\t *\n\t * @param info\n\t */\n\tprivate processHttpData( info: TransformableInfo ): TransformableInfo {\n\t\tif ( !info.request && !info.response ) {\n\t\t\treturn info;\n\t\t}\n\n\t\tconst http: Http = {};\n\t\tconst url: Url = {};\n\t\tconst source: Source = {};\n\n\t\tif ( info.request ) {\n\t\t\tconst requestData = info.request as RequestData;\n\n\t\t\t// Extract source information\n\t\t\tsource.ip = requestData.remoteAddress;\n\t\t\tsource.port = requestData.remotePort;\n\n\t\t\t// Extract URL information\n\t\t\turl.full = requestData.url;\n\t\t\t// service-template-node dynamically defines routes\n\t\t\t// which are captured with params[n]\n\t\t\t// https://expressjs.com/en/4x/api.html#req.params\n\t\t\turl.path = requestData.params?.[ 0 ] ?? requestData.path ?? '';\n\n\t\t\t// Clean up request object by removing non-ECS-mapped fields\n\t\t\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\n\t\t\tconst { remoteAddress, remotePort, url: requestUrl, params, ...cleanRequest } = requestData;\n\t\t\thttp.request = cleanRequest;\n\t\t}\n\n\t\tif ( info.response ) {\n\t\t\thttp.response = info.response as ResponseData;\n\t\t}\n\n\t\t// Create updated info object without request/response\n\t\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\n\t\tconst { request, response, ...baseInfo } = info;\n\n\t\t// Merge ECS fields with base info\n\t\treturn defu( baseInfo, {\n\t\t\thttp,\n\t\t\turl,\n\t\t\tsource,\n\t\t\tmessage: baseInfo.message,\n\t\t\tlevel: baseInfo.level\n\t\t} );\n\t}\n\n\t/**\n\t * Handles request ID transformation\n\t *\n\t * @param info\n\t */\n\tprivate processRequestId( info: TransformableInfo ): TransformableInfo {\n\t\tif ( !info.requestId && !info.request_id ) {\n\t\t\treturn info;\n\t\t}\n\n\t\tconst requestId = info.requestId ?? info.request_id;\n\t\tconst http = { request: { id: requestId } };\n\n\t\t// Create updated info object without request ID fields\n\t\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\n\t\tconst { requestId: _, request_id: __, ...baseInfo } = info;\n\n\t\t// Merge request ID with base info\n\t\treturn defu( baseInfo, {\n\t\t\thttp,\n\t\t\tmessage: baseInfo.message,\n\t\t\tlevel: baseInfo.level\n\t\t} );\n\t}\n}\n\nexport const wikimediaEcsFormatMiddleware = () => new WikimediaEcsFormatMiddleware() as Format;\n","import Prometheus from 'prom-client';\nimport type { MetricOptions } from './metric.ts';\nimport type { Metrics } from './index.ts';\nimport type { Logger } from 'winston';\n\n/**\n * Normalizes a prometheus string. Should be used for label\n * and metric names, but is not needed for label values.\n *\n * @param {string} str\n * @return {string}\n */\nexport const normalize = ( str: string ) => String( str )\n\t.replace( /\\W/g, '_' ) // replace non-alphanumerics\n\t.replace( /_+/g, '_' ) // dedupe underscores\n\t.replace( /(^_+|_+$)/g, '' ); // trim leading and trailing underscores\n\n/**\n * @deprecated Use {@link Metrics.createMetric} to use Prometheus directly.\n *\n * Prometheus metrics implementation\n */\nexport class PrometheusMetric {\n\toptions: MetricOptions;\n\n\tclient: typeof Prometheus;\n\n\tstaticLabels: any;\n\n\tmetric: Prometheus.Metric;\n\n\tconstructor( options: MetricOptions, client: typeof Prometheus ) {\n\t\tthis.client = client;\n\t\tthis.options = structuredClone( options );\n\t\tif ( this.options.labels === undefined ) {\n\t\t\tthis.options.labels = { names: [] };\n\t\t}\n\t\tthis.staticLabels = this.options.prometheus.staticLabels || {};\n\n\t\t// Add staticLabel names to list of known label names.\n\t\tObject.keys( this.staticLabels ).forEach( ( labelName ) => {\n\t\t\tthis.options.labels?.names.unshift( labelName );\n\t\t} );\n\t\t// Normalize all the label names.\n\t\tthis.options.labels.names = this.options.labels.names.map( normalize );\n\n\t\tthis.options.prometheus.name = normalize(\n\t\t\tthis.options.prometheus.name\n\t\t);\n\t\tthis.metric = new this.client[ this.options.type ]( {\n\t\t\tname: this.options.prometheus.name,\n\t\t\thelp: this.options.prometheus.help,\n\t\t\tlabelNames: this.options.labels.names,\n\t\t\tbuckets: this.options.prometheus.buckets,\n\t\t\tpercentiles: this.options.prometheus.percentiles\n\t\t} );\n\t}\n\n\t/**\n\t * Gets label values array for this metric\n\t * including both static and dynamic labels merged together.\n\t *\n\t * @param {Array} labelValues\n\t * @return {Array}\n\t */\n\t_getLabelValues( labelValues: Array<string> ) {\n\t\t// make a clone of labelValues.\n\t\tconst updatedLabelValues = [ ...labelValues ];\n\t\t// Add staticLabel values to updatedLabelValues if they aren't already listed.\n\t\tObject.keys( this.staticLabels ).forEach( ( labelName ) => {\n\t\t\tif ( !updatedLabelValues.includes( this.staticLabels[ labelName ] ) ) {\n\t\t\t\tupdatedLabelValues.unshift( this.staticLabels[ labelName ] );\n\t\t\t}\n\t\t} );\n\t\treturn updatedLabelValues;\n\t}\n\n\tincrement( amount: number, labelValues: Array<string> ) {\n\t\tconst updatedLabelValues = this._getLabelValues( labelValues );\n\t\t// @ts-ignore\n\t\tthis.metric.labels.apply( this.metric, updatedLabelValues ).inc( amount );\n\t}\n\n\tdecrement( amount: number, labelValues: Array<string> ) {\n\t\tconst updatedLabelValues = this._getLabelValues( labelValues );\n\t\t// @ts-ignore\n\t\tthis.metric.labels.apply( this.metric, updatedLabelValues ).dec( amount );\n\t}\n\n\tobserve( value: number, labelValues: Array<string> ) {\n\t\tconst updatedLabelValues = this._getLabelValues( labelValues );\n\t\t// @ts-ignore\n\t\tthis.metric.labels.apply( this.metric, updatedLabelValues ).observe( value );\n\t}\n\n\tgauge( amount: number, labelValues: Array<string> ) {\n\t\tconst updatedLabelValues = this._getLabelValues( labelValues );\n\t\tif ( amount < 0 ) {\n\t\t\t// @ts-ignore\n\t\t\tthis.metric.labels\n\t\t\t\t.apply( this.metric, updatedLabelValues )\n\t\t\t// @ts-ignore\n\t\t\t\t.dec( Math.abs( amount ) );\n\t\t} else {\n\t\t\t// @ts-ignore\n\t\t\tthis.metric.labels.apply( this.metric, updatedLabelValues ).inc( amount );\n\t\t}\n\t}\n\n\tset( value: number, labelValues: Array<string> ) {\n\t\tconst updatedLabelValues = this._getLabelValues( labelValues );\n\t\t// @ts-ignore\n\t\tthis.metric.labels.apply( this.metric, updatedLabelValues ).set( value );\n\t}\n\n\ttiming( value: number, labelValues: Array<string> ) {\n\t\tconst updatedLabelValues = this._getLabelValues( labelValues );\n\t\tthis.observe( value, updatedLabelValues );\n\t}\n\n\tendTiming( startTime: number, labelValues: Array<string> ) {\n\t\tconst updatedLabelValues = this._getLabelValues( labelValues );\n\t\tthis.timing( ( Date.now() - startTime ) / 1000, updatedLabelValues );\n\t}\n}\n\n/**\n * @deprecated Use {@link Metrics.createMetric} to use Prometheus directly.\n */\nexport default class PrometheusClient {\n\tlogger: Logger;\n\n\tclient: typeof Prometheus;\n\n\tconstructor( logger: Logger ) {\n\t\tthis.logger = logger;\n\t\tthis.client = Prometheus;\n\t}\n\n\tmakeMetric( options: MetricOptions ) {\n\t\treturn new PrometheusMetric( options, this.client );\n\t}\n\n\tclose() {}\n}\n","/**\n * @deprecated Legacy code from service-runner\n */\nimport type { Logger } from 'winston';\nimport type { Metrics, MetricType } from './index.ts';\nimport PrometheusClient, { PrometheusMetric } from './prometheus.ts';\n\n// types correlate to Prometheus metric types.\nexport enum MetricTypeEnum {\n\tGAUGE = 'Gauge',\n\tHISTOGRAM = 'Histogram',\n\tCOUNTER = 'Counter',\n\tSUMMARY = 'Summary',\n\t// eslint-disable-next-line @typescript-eslint/no-duplicate-enum-values\n\tTIMING = 'Histogram',\n}\n\n/**\n * @deprecated Use {@link Metrics.createMetric} to avoid using this interface.\n *\n * These options are for the specific metric being measured.\n *\n * @example\n * {\n *   type: 'Counter',\n *   name: 'hitcount',\n *   prometheus: {\n *     name: 'hitcount',\n *     help: 'hit count',\n *     staticLabels: {},  // a key-value pair of labels\n *     buckets: [], // https://github.com/siimon/prom-client#histogram\n *     percentiles: [], // https://github.com/siimon/prom-client#summary\n *   },\n *   sampleRate: 1, // default 1 https://github.com/brightcove/hot-shots/blob/v6.3.0/README.md#usage\n *   labels: {\n *     names: [],\n *     labelPosition: 'before',\n *     omitLabelNames: false\n *   }\n * }\n */\nexport interface MetricOptions {\n\ttype: MetricType;\n\t/**\n\t * Metrics are cached by this name, as opposed to makeRawMetrics\n\t * where it's cached by the Prometheus metrics name\n\t */\n\tname: string;\n\tprometheus: {\n\t\tname: string;\n\t\thelp: string;\n\t\tstaticLabels?: Record<string, string>;\n\t\tbuckets?: Array<number>;\n\t\tpercentiles?: Array<number>;\n\t};\n\tsampleRate?: number; // Default 1\n\tlabels?: {\n\t\tnames: Array<string>;\n\t\tlabelPosition?: string;\n\t\tomitLabelNames?: boolean;\n\t};\n}\n\n/**\n * @deprecated Use {@link Metrics.createMetric} to use Prometheus directly.\n *\n * This class is a wrapper to call metrics functions\n */\nexport class Metric {\n\ttype: MetricType;\n\n\tmetric: PrometheusMetric;\n\n\tlogger: Logger;\n\n\tconstructor(\n\t\tclient: PrometheusClient,\n\t\tlogger: Logger,\n\t\toptions: MetricOptions\n\t) {\n\t\tthis.type = options.type;\n\t\tthis.logger = logger;\n\t\tthis.metric = client.makeMetric( options );\n\t}\n\n\tincrement( amount = 1, labels: Array<string> = [] ) {\n\t\tif ( [ MetricTypeEnum.COUNTER, MetricTypeEnum.GAUGE ].includes( this.type as MetricTypeEnum ) ) {\n\t\t\tthis.metric.increment( amount, labels );\n\t\t} else {\n\t\t\tthis.logger.error(\n\t\t\t\t`increment() unsupported for metric type ${ this.type }`,\n\t\t\t\t{ levelPath: 'error/metrics' }\n\t\t\t);\n\t\t}\n\t}\n\n\tdecrement( amount = 1, labels: Array<string> = [] ) {\n\t\tif ( this.type === MetricTypeEnum.GAUGE ) {\n\t\t\tthis.metric.decrement( amount, labels );\n\t\t} else {\n\t\t\tthis.logger.error(\n\t\t\t\t`decrement() unsupported for metric type ${ this.type }`,\n\t\t\t\t{ levelPath: 'error/metrics' }\n\t\t\t);\n\t\t}\n\t}\n\n\tobserve( value: number, labels: Array<string> = [] ) {\n\t\tif ( [ MetricTypeEnum.HISTOGRAM, MetricTypeEnum.SUMMARY ].includes( this.type as MetricTypeEnum ) ) {\n\t\t\tthis.metric.observe( value, labels );\n\t\t} else {\n\t\t\tthis.logger.error( `observe() unsupported for metric type ${ this.type }`, {\n\t\t\t\tlevelPath: 'error/metrics'\n\t\t\t} );\n\t\t}\n\t}\n\n\tgauge( amount: number, labels: Array<string> = [] ) {\n\t\tif ( this.type === MetricTypeEnum.GAUGE ) {\n\t\t\tthis.metric.gauge( amount, labels );\n\t\t} else {\n\t\t\tthis.logger.error(\n\t\t\t\t`set() or unique() unsupported for metric type ${ this.type }`,\n\t\t\t\t{ levelPath: 'error/metrics' }\n\t\t\t);\n\t\t}\n\t}\n\n\tset( value: number, labels: Array<string> = [] ) {\n\t\tif ( this.type === MetricTypeEnum.GAUGE ) {\n\t\t\tthis.metric.set( value, labels );\n\t\t} else {\n\t\t\tthis.logger.error(\n\t\t\t\t`set() or unique() unsupported for metric type ${ this.type }`,\n\t\t\t\t{ levelPath: 'error/metrics' }\n\t\t\t);\n\t\t}\n\t}\n\n\ttiming( value: number, labels: Array<string> = [] ) {\n\t\tif ( this.type === MetricTypeEnum.TIMING ) {\n\t\t\tthis.metric.timing( value, labels );\n\t\t} else {\n\t\t\tthis.logger.error( `timing() unsupported for metric type ${ this.type }`, {\n\t\t\t\tlevelPath: 'error/metrics'\n\t\t\t} );\n\t\t}\n\t}\n\n\tendTiming( startTime: number, labels: Array<string> = [] ) {\n\t\tif ( this.type === MetricTypeEnum.TIMING ) {\n\t\t\tthis.metric.endTiming( startTime, labels );\n\t\t} else {\n\t\t\tthis.logger.error(\n\t\t\t\t`endTiming() unsupported for metric type ${ this.type }`,\n\t\t\t\t{ levelPath: 'error/metrics' }\n\t\t\t);\n\t\t}\n\t}\n}\n","import type Prometheus from 'prom-client';\nimport PrometheusClient, { normalize } from './prometheus.ts';\nimport { Metric, type MetricOptions, type MetricTypeEnum } from './metric.ts';\nimport type { PrometheusMetricsConfig } from './prometheus_server.ts';\nimport type { Logger } from 'winston';\n\nexport type MetricType = MetricTypeEnum | `${ MetricTypeEnum }`;\n\ntype GenericPrometheusMetricsConfig<T extends MetricType> =\n\tConstructorParameters<typeof Prometheus[T]>[0];\n\ntype RawMetricOptions<T extends MetricType> =\n\tGenericPrometheusMetricsConfig<T>\n\t& {\n\t\ttype: T,\n\t\t[key: string]: any\n\t};\n\nexport class Metrics {\n\toptions: PrometheusMetricsConfig | undefined;\n\n\tclient: PrometheusClient;\n\n\tprometheus: typeof Prometheus;\n\n\tserviceName: string;\n\n\tcache: Map<string, Metric>;\n\n\tlogger: Logger;\n\n\tconstructor(\n\t\tserviceName: string,\n\t\tlogger: Logger,\n\t\toptions?: PrometheusMetricsConfig\n\t) {\n\t\tthis.options = options;\n\t\tthis.logger = logger;\n\t\tthis.cache = new Map();\n\t\tthis.serviceName = serviceName;\n\t\tif ( !options || options && options.type === 'prometheus' ) {\n\t\t\tthis.client = new PrometheusClient(\n\t\t\t\tthis.logger\n\t\t\t);\n\t\t\tthis.prometheus = this.client.client;\n\t\t\treturn;\n\t\t}\n\t\tlogger.error(\n\t\t\t`No such metrics client: '${ options.type ?? 'undefined' }'`\n\t\t);\n\t}\n\n\tgetServiceName() {\n\t\treturn this.serviceName;\n\t}\n\n\t// T247820: Selectively disable service label based on environment variable.\n\t// Intended for production use case where the service label will be set\n\t// by the Prometheus server.\n\tgetServiceLabel() {\n\t\tif ( process.env.METRICS_SERVICE_LABEL_ENABLED === 'false' ) {\n\t\t\treturn undefined;\n\t\t}\n\t\treturn { service: this.serviceName };\n\t}\n\n\t/**\n\t * @deprecated Remnant from service-runner. Use Prometheus directly.\n\t */\n\tfetchClient() {\n\t\treturn this.client;\n\t}\n\n\t/**\n\t * @deprecated Use {@link createMetric} for new projects.\n\t *\n\t * @param options\n\t * @return\n\t */\n\tmakeMetric( options: MetricOptions ) {\n\t\tlet metric = this.cache.get( options.name );\n\t\tif ( metric === undefined ) {\n\t\t\tmetric = new Metric( this.client, this.logger, options );\n\t\t\tthis.cache.set( options.name, metric );\n\t\t}\n\t\treturn metric;\n\t}\n\n\t/**\n\t * Makes and returns a raw Prometheus Metric bypassing the service-runner wrapper.\n\t *\n\t * @param options\n\t * @return\n\t */\n\tcreateMetric<T extends MetricType>(\n\t\t// Dynamically types the options to be the metrics options for Prometheus\n\t\toptions: RawMetricOptions<T>\n\t): InstanceType<typeof Prometheus[T]> {\n\t\tconst normalisedName = normalize( options.name );\n\t\tlet metric = this.prometheus.register.getSingleMetric( normalisedName );\n\t\tif ( metric ) {\n\t\t\treturn metric as InstanceType<typeof Prometheus[T]>;\n\t\t}\n\n\t\tlet labelNames = [ normalisedName ];\n\t\tif ( options.labels?.names ) {\n\t\t\tlabelNames = labelNames.concat( options.labels.names );\n\t\t}\n\n\t\tmetric = new this.prometheus[ options.type ]( {\n\t\t\tname: normalisedName,\n\t\t\thelp: options.help,\n\t\t\tlabelNames,\n\t\t\tbuckets: options.buckets,\n\t\t\tpercentiles: options.percentiles\n\t\t} );\n\n\t\tthis.prometheus.register.registerMetric( metric );\n\t\treturn metric as InstanceType<typeof Prometheus[T]>;\n\t}\n\n\tclose() {\n\t\tthis.client.close();\n\t}\n}\n","import Prometheus from 'prom-client';\nimport HTTP from 'http';\n\n// This is used for Prometheus Client and Server\nexport interface PrometheusMetricsConfig {\n\ttype: 'prometheus'; // TODO: Remove. Prometheus is the only supported type.\n\tport: number;\n\tname?: string; // TODO: Remove. Unused, from service-runner.\n\tcollectDefaultMetrics?: boolean;\n}\n\n// Builds up an HTTP endpoint per Prometheus config\nexport default class PrometheusServer {\n\tconfig: PrometheusMetricsConfig;\n\n\tserver: HTTP.Server;\n\n\tconstructor( config: PrometheusMetricsConfig, defaultLabels: Record<string, string> = { service: 'default_service' } ) {\n\t\tthis.config = config;\n\t\tif ( this.config.collectDefaultMetrics !== false ) {\n\t\t\tPrometheus.collectDefaultMetrics();\n\t\t}\n\t\tPrometheus.register.setDefaultLabels( defaultLabels );\n\t\tthis.server = HTTP.createServer( async ( req, res ) => {\n\t\t\tres.end( await Prometheus.register.metrics() );\n\t\t} );\n\t}\n\n\tstart() {\n\t\tthis.server.listen( this.config.port );\n\t}\n\n\tasync close() {\n\t\tPrometheus.register.clear();\n\t\tthis.server.close( ( err ) => {\n\t\t\tPromise.resolve( err );\n\t\t} );\n\t}\n}\n","import type { NextFunction, Request as ExpressRequest, Response as ExpressResponse, Express, Router } from 'express';\nimport type { Metrics } from './metric/index.ts';\nimport { MetricTypeEnum } from './metric/metric.ts';\nimport { type ServiceUtils } from './index.ts';\n\n/**\n * @deprecated Use {@link responseTimeMetricsMiddleware} for new projects.\n *\n * Adapted from service-template-node.\n * https://github.com/wikimedia/service-template-node/blob/main/lib/util.js\n *\n * Awaits all of the given router's handler functions\n * inside a try/catch block so as to allow catching all errors,\n * regardless of whether a handler is async or not.\n *\n * If registering routes with sub-routers\n *\n * @param {Express} app the Express application or the Router itself\n * @param {Metrics} metrics the metrics object\n * @param {string} subPath the subpath from the main express router, if applicable\n */\nexport const wrapRouteHandlers = ( app: Express | Router, metrics: Metrics, subPath: string = '' ) => {\n\tconst router = ( app as Express )._router ?? app;\n\t( router as Router ).stack\n\t\t// Ignore built-in routes (they have route:null in the stack)\n\t\t.flatMap( ( routerLayer ) => routerLayer.route ? routerLayer : [] )\n\t\t.forEach( ( routerLayer ) => {\n\t\t\tconst path = ( subPath + '/' + routerLayer.route?.path.slice( 1 ) )\n\t\t\t\t.replace( /\\/:/g, '/--' )\n\t\t\t\t.replace( /^\\//, '' )\n\t\t\t\t.replace( /[/?]+$/, '' );\n\n\t\t\trouterLayer?.route?.stack.forEach( ( layer: any ) => {\n\t\t\t\tconst origHandler = layer.handle;\n\t\t\t\tconst metric = metrics.makeMetric( {\n\t\t\t\t\ttype: MetricTypeEnum.HISTOGRAM,\n\t\t\t\t\tname: 'router',\n\t\t\t\t\tprometheus: {\n\t\t\t\t\t\tname: 'express_router_request_duration_seconds',\n\t\t\t\t\t\thelp: 'request duration handled by router in seconds',\n\t\t\t\t\t\tstaticLabels: metrics.getServiceLabel(),\n\t\t\t\t\t\tbuckets: [ 0.01, 0.05, 0.1, 0.3, 1 ]\n\t\t\t\t\t},\n\t\t\t\t\tlabels: {\n\t\t\t\t\t\tnames: [ 'path', 'method', 'status' ],\n\t\t\t\t\t\tomitLabelNames: true\n\t\t\t\t\t}\n\t\t\t\t} );\n\t\t\t\tlayer.handle = async (\n\t\t\t\t\treq: ExpressRequest,\n\t\t\t\t\tres: ExpressResponse,\n\t\t\t\t\tnext: NextFunction\n\t\t\t\t) => {\n\t\t\t\t\tconst startTime = Date.now();\n\t\t\t\t\ttry {\n\t\t\t\t\t\tawait origHandler( req, res, next );\n\t\t\t\t\t} catch {\n\t\t\t\t\t\tawait next();\n\t\t\t\t\t} finally {\n\t\t\t\t\t\tlet statusCode = res.statusCode || 500;\n\t\t\t\t\t\tif ( statusCode < 100 || statusCode > 599 ) {\n\t\t\t\t\t\t\tstatusCode = 500;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tmetric.endTiming( startTime, [\n\t\t\t\t\t\t\tpath || 'root',\n\t\t\t\t\t\t\treq.method,\n\t\t\t\t\t\t\tstatusCode.toString()\n\t\t\t\t\t\t] );\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t} );\n\t\t} );\n};\n\n/**\n * Reverse map Express parameters to a route.\n *\n * @example\n * // returns '/:id1/2/:id2/4'\n * _replacePathWithPlaceholders('/1/2/3/4', [[\"id1\", \"1\"], [\"id2\", \"3\"]])\n *\n * @param {string} path\n * @param {Array<[string, string]>} params\n *   Ordered array of [paramName, paramValue] pairs to map onto path\n * @return\n */\nexport const _replacePathWithPlaceholders = (\n\tpath: string, params: Array<[string, string]> = []\n) => {\n\tif ( !path ) {\n\t\treturn '';\n\t} // Handle empty path case\n\n\tconst paramQueue = [ ...params ]; // Copy params to process sequentially\n\tconst usedKeys = new Set(); // Ensure each key is used only once per matching value\n\n\treturn path.split( '/' ).map( ( segment ) => {\n\t\tfor ( let i = 0; i < paramQueue.length; i++ ) {\n\t\t\tconst [ key, value ] = paramQueue[ i ];\n\t\t\tif ( segment === value && !usedKeys.has( key ) ) {\n\t\t\t\tusedKeys.add( key ); // Mark key as used\n\t\t\t\treturn `:${ key }`;\n\t\t\t}\n\t\t}\n\t\treturn segment; // Keep unchanged if no match\n\t} ).join( '/' );\n};\n\n/**\n * Use alongside {@link responseTimeMetricsMiddleware} to enable metrics for\n * routes inside sub-routers. If the same sub-router is registered multiple times,\n * it uses the last called path.\n *\n * @example\n * const app = express();\n * app.use( helpers.responseTimeMetricsMiddleware( serviceUtils ) );\n * const subRouter = express.Router();\n *\n * app.get( '/', ( req, res ) => res.end() );\n * subRouter.get( '/', ( req, res ) => res.end() );\n *\n * prefixRouterPathMiddleware('/sub', subRouter);\n * app.use( '/sub', subRouter );\n *\n * @param {string} path path to router\n * @param {Router} router\n */\nexport const prefixRouterPathMiddleware = (\n\tpath: string, router: Router\n) => {\n\tconst MIDDLEWARE_NAME = 'prefixRouterPathMiddleware';\n\n\t// Remove trailing slash if there is one\n\tpath = path.replace( /\\/$/, '' );\n\n\trouter.stack = router.stack\n\t\t.filter( ( layer ) => layer.name !== MIDDLEWARE_NAME );\n\n\t// Register middleware to instantiate a Layer object\n\trouter.use( ( req, res, next ) => {\n\t\treq[ 'subPath' ] = req[ 'subPath' ] ? req[ 'subPath' ] + path : path;\n\t\tnext();\n\t} );\n\n\t// Move middleware to the front so it gets called first\n\tconst middlewareLayer = router.stack.pop();\n\tif ( middlewareLayer ) {\n\t\tmiddlewareLayer.name = MIDDLEWARE_NAME;\n\t\trouter.stack.unshift( middlewareLayer );\n\t}\n};\n\n/**\n * Adapted from cxserver\n * https://github.com/wikimedia/mediawiki-services-cxserver/blob/master/lib/util.js\n *\n * Wraps all routes in response time metrics.\n * The only behavioral change from service-template-node is\n * the original route is kept instead of normalized.\n *\n * To enable metrics for routes inside sub-routers,\n * use alongside {@link prefixRouterPathMiddleware}.\n *\n * @param {ServiceUtils} serviceUtils\n * @param {boolean} legacyPathNaming\n *   Whether to use the path naming conventions from service-template-node\n * @return\n */\nexport const responseTimeMetricsMiddleware = (\n\tserviceUtils: ServiceUtils, legacyPathNaming?: boolean\n) => {\n\t// Create a histogram metric for HTTP request duration\n\tconst requestDuration = {\n\t\ttype: MetricTypeEnum.HISTOGRAM as const,\n\t\tname: 'express_router_request_duration_seconds',\n\t\thelp: 'request duration handled by router in seconds',\n\t\tbuckets: [ 0.01, 0.05, 0.1, 0.3, 1 ],\n\t\tlabels: {\n\t\t\tnames: [ 'service', 'path', 'method', 'status' ]\n\t\t}\n\t};\n\t// Create the metric\n\t// This will return the existing metric if it already exists\n\tconst responseTimeMetric = serviceUtils\n\t\t.metrics.createMetric<MetricTypeEnum.HISTOGRAM>( requestDuration );\n\tserviceUtils.logger.info( 'responseTimeMetric', responseTimeMetric.labels );\n\treturn ( req, res, next ) => {\n\t\tconst endTimer = responseTimeMetric.startTimer();\n\t\tconst originalEnd = res.end;\n\n\t\tres.end = ( ...args ) => {\n\t\t\t// req.route.path is the matched string pattern relative to its local router\n\t\t\t// If there's no match or it's a catch-all, default to '/'\n\t\t\tlet path = req.route?.path && req.route.path !== '*' ? req.route.path : '/';\n\n\t\t\t// Apply subPath if available\n\t\t\tif ( req.subPath ) {\n\t\t\t\tpath = path === '/' ? req.subPath : req.subPath + path;\n\t\t\t} else if ( req.baseUrl ) {\n\t\t\t\t// If there is no subpath (like if the user forgets to register it),\n\t\t\t\t// attempt to reconstruct it.\n\t\t\t\t// This only works for routes that use params and\n\t\t\t\t// with { mergeParams: true } set in options\n\t\t\t\tpath = _replacePathWithPlaceholders(\n\t\t\t\t\treq.baseUrl + path, Object.entries( req.params ?? [] )\n\t\t\t\t).replace( /\\/$/, '' ); // Remove trailing slash if there is one\n\t\t\t}\n\n\t\t\t// Default to subPath or root if no route is matched (i.e. 404)\n\t\t\tif ( !path || !req.route ) {\n\t\t\t\tpath = req.subPath ?? '/';\n\t\t\t}\n\n\t\t\tif ( legacyPathNaming ) {\n\t\t\t\tpath = path\n\t\t\t\t\t.replace( /\\/:/g, '/--' )\n\t\t\t\t\t.replace( /^\\//, '' )\n\t\t\t\t\t.replace( /[/?]+$/, '' );\n\t\t\t\tpath = path || 'root';\n\t\t\t}\n\t\t\t// Observe the duration\n\t\t\tendTimer( {\n\t\t\t\tservice: serviceUtils.config.service_name,\n\t\t\t\tpath: path,\n\t\t\t\tmethod: req.method,\n\t\t\t\tstatus: res.statusCode\n\t\t\t} );\n\t\t\t// Call the original end function\n\t\t\toriginalEnd.apply( res, args );\n\t\t};\n\t\t// Continue processing the request\n\t\tnext();\n\t};\n};\n","import { v1 as uuidv1 } from 'uuid';\n\nexport const X_REQUEST_HEADER = 'x-request-id';\n\n/**\n * Takes headers and extracts any trace headers (x-request-id, traceparent, tracestate)\n * and applies it to new headers.\n *\n * @param {HeadersInit} headers Headers to extract trace from\n * @return {Headers} new headers with trace headers set\n */\nexport const extractTraceContext = ( headers: HeadersInit ): Headers => {\n\tconst _headers = new Headers( headers );\n\tconst newHeaders = new Headers( {\n\t\t'x-request-id': _headers.get( 'x-request-id' ) ?? uuidv1()\n\t} );\n\t[ 'traceparent', 'tracestate' ].forEach( ( key ) => {\n\t\tconst value = _headers.get( key );\n\t\tif ( value ) {\n\t\t\tnewHeaders.set( key, value );\n\t\t}\n\t} );\n\treturn newHeaders;\n};\n","import {\n\tContext,\n\tpropagation,\n\tTextMapGetter,\n\tTextMapPropagator,\n\tTextMapSetter\n} from '@opentelemetry/api';\nimport { v1 as uuidv1 } from 'uuid';\n\nimport { X_REQUEST_HEADER } from './trace.ts';\n\n/**\n * @experimental\n * Propagates `x-request-id` headers. Used with OpenTelemetry.\n */\nexport class XRequestPropagator implements TextMapPropagator {\n\n\t/**\n\t * Injects values from a given `Context` into a carrier.\n\t *\n\t * OpenTelemetry defines a common set of format values (TextMapPropagator),\n\t * and each has an expected `carrier` type.\n\t *\n\t * @param {Context} context the Context from which to extract values to transmit over\n\t *     the wire.\n\t * @param {unknown} carrier the carrier of propagation fields, such as http request\n\t *     headers.\n\t * @param {TextMapSetter} setter an optional {@link TextMapSetter}. If undefined, values will be\n\t *     set by direct object assignment.\n\t */\n\tinject( context: Context, carrier: unknown, setter: TextMapSetter ): void {\n\t\tsetter.set(\n\t\t\tcarrier,\n\t\t\tX_REQUEST_HEADER,\n\t\t\tpropagation.getBaggage( context )?.getEntry( X_REQUEST_HEADER )?.value ?? uuidv1()\n\t\t);\n\t}\n\n\t/**\n\t * Given a `Context` and a carrier, extract context values from a\n\t * carrier and return a new context, created from the old context, with the\n\t * extracted values.\n\t *\n\t * @param {Context} context the Context from which to extract values to transmit over\n\t *     the wire.\n\t * @param {unknown} carrier the carrier of propagation fields, such as http request\n\t *     headers.\n\t * @param {TextMapGetter} getter an optional {@link TextMapGetter}. If undefined,\n\t *     keys will be all own properties, and keys will be accessed by direct object access.\n\t * @return {Context} context\n\t */\n\textract( context: Context, carrier: unknown, getter: TextMapGetter ): Context {\n\t\tconst headers = getter.get( carrier, X_REQUEST_HEADER );\n\t\tconst xRequestHeader = Array.isArray( headers ) ? headers[ 0 ] : headers;\n\t\tif ( !xRequestHeader ) {\n\t\t\treturn context;\n\t\t}\n\n\t\tlet baggage = propagation.getBaggage( context ) ?? propagation.createBaggage();\n\t\tbaggage = baggage.setEntry( X_REQUEST_HEADER, { value: xRequestHeader } );\n\n\t\treturn propagation.setBaggage( context, baggage );\n\t}\n\n\tfields(): string[] {\n\t\treturn [ X_REQUEST_HEADER ];\n\t}\n}\n"],"mappings":";AAAA,OAAO,UAAU;AACjB,OAAO,WAAW;AAClB,SAAS,eAAe;AACxB,SAAS,kBAAkB;;;ACH3B,OAAO,aAAa;AACpB,SAAS,WAAW,oBAAoB;;;ACCxC,SAAS,OAAO,SAAS,aAAa;AAEtC,SAAS,YAAY;AAqDrB,IAAM,+BAAN,MAAqD;AAAA,EACpD,UAAW,MAA6C;AAEvD,UAAM,cAAc,KAAK,mBAAoB,IAAK;AAGlD,UAAM,WAAW,KAAK,gBAAiB,WAAY;AAGnD,UAAM,gBAAgB,KAAK,iBAAkB,QAAS;AAGtD,kBAAe,KAAM,IAAI,KAAM,KAAM;AACrC,kBAAe,OAAQ,IAAI,KAAM,OAAQ;AACzC,kBAAe,KAAM,IAAI,KAAM,KAAM;AAErC,WAAO;AAAA,EACR;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOQ,mBAAoB,MAA6C;AACxE,QAAK,CAAC,KAAK,eAAe,EAAG,KAAK,WAAW,OAAO,KAAK,YAAY,WAAa;AACjF,aAAO;AAAA,IACR;AAEA,UAAM,cAAc,KAAK,eAAe,KAAK;AAC7C,UAAM,cAAc,EAAE,GAAG,KAAK;AAE9B,gBAAY,UAAU,EAAE,MAAM,YAAY;AAC1C,WAAO,YAAY;AAEnB,WAAO;AAAA,EACR;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQQ,gBAAiB,MAA6C;AArGvE;AAsGE,QAAK,CAAC,KAAK,WAAW,CAAC,KAAK,UAAW;AACtC,aAAO;AAAA,IACR;AAEA,UAAM,OAAa,CAAC;AACpB,UAAM,MAAW,CAAC;AAClB,UAAM,SAAiB,CAAC;AAExB,QAAK,KAAK,SAAU;AACnB,YAAM,cAAc,KAAK;AAGzB,aAAO,KAAK,YAAY;AACxB,aAAO,OAAO,YAAY;AAG1B,UAAI,OAAO,YAAY;AAIvB,UAAI,SAAO,iBAAY,WAAZ,mBAAsB,OAAO,YAAY,QAAQ;AAI5D,YAAM,EAAE,eAAe,YAAY,KAAK,YAAY,QAAQ,GAAG,aAAa,IAAI;AAChF,WAAK,UAAU;AAAA,IAChB;AAEA,QAAK,KAAK,UAAW;AACpB,WAAK,WAAW,KAAK;AAAA,IACtB;AAIA,UAAM,EAAE,SAAS,UAAU,GAAG,SAAS,IAAI;AAG3C,WAAO,KAAM,UAAU;AAAA,MACtB;AAAA,MACA;AAAA,MACA;AAAA,MACA,SAAS,SAAS;AAAA,MAClB,OAAO,SAAS;AAAA,IACjB,CAAE;AAAA,EACH;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOQ,iBAAkB,MAA6C;AACtE,QAAK,CAAC,KAAK,aAAa,CAAC,KAAK,YAAa;AAC1C,aAAO;AAAA,IACR;AAEA,UAAM,YAAY,KAAK,aAAa,KAAK;AACzC,UAAM,OAAO,EAAE,SAAS,EAAE,IAAI,UAAU,EAAE;AAI1C,UAAM,EAAE,WAAW,GAAG,YAAY,IAAI,GAAG,SAAS,IAAI;AAGtD,WAAO,KAAM,UAAU;AAAA,MACtB;AAAA,MACA,SAAS,SAAS;AAAA,MAClB,OAAO,SAAS;AAAA,IACjB,CAAE;AAAA,EACH;AACD;AAEO,IAAM,+BAA+B,MAAM,IAAI,6BAA6B;;;ADvKnF,IAAM,YAAY;AAAA,EACjB,OAAO;AAAA,EACP,OAAO;AAAA,EACP,MAAM;AAAA,EACN,MAAM;AAAA,EACN,MAAM;AAAA,EACN,SAAS;AAAA,EACT,OAAO;AAAA,EACP,OAAO;AAAA,EACP,OAAO;AACR;AA4BO,IAAM,sBAAsB,CAClC,aACA,UAAgC,CAAC,MAC7B;AAGJ,YAAU;AAAA,IACT,GAAG;AAAA,MACF,OAAO;AAAA,MACP,YAAY;AAAA,MACZ,QAAQ;AAAA,MACR,YAAY,CAAE,EAAE,WAAW,UAAU,CAAE;AAAA,IACxC;AAAA,IACA,GAAG;AAAA,EACJ;AAEA,QAAM,eAAe;AAAA,IACpB,UAAW,EAAE,eAAe,MAAM,GAAG,QAAQ,cAAc,CAAE;AAAA,IAC7D,6BAA6B;AAAA,IAC7B,aAAa;AAAA,EACd;AAEA,SAAO,QAAQ,aAAc;AAAA,IAC5B,QAAQ;AAAA,IACR,OAAO,QAAQ;AAAA,IACf,QAAQ,QAAQ,OAAO;AAAA,MACtB,GAAG;AAAA;AAAA,QACF,QAAQ,OAAO,OAAQ,EAAE,OAAO,QAAQ,WAAW,CAAE;AAAA,QACrD,QAAQ,WAAW,QAClB,eACA,QAAQ,OAAQ,QAAQ,UAAU,MAAO;AAAA,UACxC,QAAQ,SAAS,QAAQ,gBAAgB;AAAA,QAC1C;AAAA,MAAE,EAAE,KAAK;AAAA,IACZ;AAAA,IACA,aAAa;AAAA,MACZ,SAAS;AAAA,QACR,MAAM;AAAA,MACP;AAAA,MACA,GAAG,QAAQ;AAAA,IACZ;AAAA,IACA,aAAc,QAAQ,cAAc,CAAC,GAAI;AAAA,MACxC,CAAE,EAAE,WAAW,SAAS,iBAAiB;AAAA;AAAA,QAExC,IAAI,QAAQ,WAAY,SAAU,EAAG;AAAA,UACpC,GAAG;AAAA;AAAA,UAEH,IAAK,qDAAkB,UACtB;AAAA,YACC,QAAQ,QAAQ,OAAO;AAAA,cACtB,GAAG;AAAA,gBAAE,QAAQ,OAAO,OAAQ,EAAE,OAAO,QAAQ,WAAW,CAAE;AAAA,gBACzD,iBAAiB,WAAW,QAC3B,eACA,QAAQ,OAAQ,iBAAiB,MAAO;AAAA,kBACvC,iBAAiB;AAAA,gBAClB;AAAA,cAAE,EAAE,KAAK;AAAA,YACZ;AAAA,UACD,IACA,CAAC;AAAA,QACH,CAAE;AAAA;AAAA,IAEJ;AAAA,EACD,CAAE;AACH;;;ADhGA,OAAOA,iBAAgB;;;AGXvB,OAAO,gBAAgB;AAYhB,IAAM,YAAY,CAAE,QAAiB,OAAQ,GAAI,EACtD,QAAS,OAAO,GAAI,EACpB,QAAS,OAAO,GAAI,EACpB,QAAS,cAAc,EAAG;AAOrB,IAAM,mBAAN,MAAuB;AAAA,EAC7B;AAAA,EAEA;AAAA,EAEA;AAAA,EAEA;AAAA,EAEA,YAAa,SAAwB,QAA4B;AAChE,SAAK,SAAS;AACd,SAAK,UAAU,gBAAiB,OAAQ;AACxC,QAAK,KAAK,QAAQ,WAAW,QAAY;AACxC,WAAK,QAAQ,SAAS,EAAE,OAAO,CAAC,EAAE;AAAA,IACnC;AACA,SAAK,eAAe,KAAK,QAAQ,WAAW,gBAAgB,CAAC;AAG7D,WAAO,KAAM,KAAK,YAAa,EAAE,QAAS,CAAE,cAAe;AAxC7D;AAyCG,iBAAK,QAAQ,WAAb,mBAAqB,MAAM,QAAS;AAAA,IACrC,CAAE;AAEF,SAAK,QAAQ,OAAO,QAAQ,KAAK,QAAQ,OAAO,MAAM,IAAK,SAAU;AAErE,SAAK,QAAQ,WAAW,OAAO;AAAA,MAC9B,KAAK,QAAQ,WAAW;AAAA,IACzB;AACA,SAAK,SAAS,IAAI,KAAK,OAAQ,KAAK,QAAQ,IAAK,EAAG;AAAA,MACnD,MAAM,KAAK,QAAQ,WAAW;AAAA,MAC9B,MAAM,KAAK,QAAQ,WAAW;AAAA,MAC9B,YAAY,KAAK,QAAQ,OAAO;AAAA,MAChC,SAAS,KAAK,QAAQ,WAAW;AAAA,MACjC,aAAa,KAAK,QAAQ,WAAW;AAAA,IACtC,CAAE;AAAA,EACH;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EASA,gBAAiB,aAA6B;AAE7C,UAAM,qBAAqB,CAAE,GAAG,WAAY;AAE5C,WAAO,KAAM,KAAK,YAAa,EAAE,QAAS,CAAE,cAAe;AAC1D,UAAK,CAAC,mBAAmB,SAAU,KAAK,aAAc,SAAU,CAAE,GAAI;AACrE,2BAAmB,QAAS,KAAK,aAAc,SAAU,CAAE;AAAA,MAC5D;AAAA,IACD,CAAE;AACF,WAAO;AAAA,EACR;AAAA,EAEA,UAAW,QAAgB,aAA6B;AACvD,UAAM,qBAAqB,KAAK,gBAAiB,WAAY;AAE7D,SAAK,OAAO,OAAO,MAAO,KAAK,QAAQ,kBAAmB,EAAE,IAAK,MAAO;AAAA,EACzE;AAAA,EAEA,UAAW,QAAgB,aAA6B;AACvD,UAAM,qBAAqB,KAAK,gBAAiB,WAAY;AAE7D,SAAK,OAAO,OAAO,MAAO,KAAK,QAAQ,kBAAmB,EAAE,IAAK,MAAO;AAAA,EACzE;AAAA,EAEA,QAAS,OAAe,aAA6B;AACpD,UAAM,qBAAqB,KAAK,gBAAiB,WAAY;AAE7D,SAAK,OAAO,OAAO,MAAO,KAAK,QAAQ,kBAAmB,EAAE,QAAS,KAAM;AAAA,EAC5E;AAAA,EAEA,MAAO,QAAgB,aAA6B;AACnD,UAAM,qBAAqB,KAAK,gBAAiB,WAAY;AAC7D,QAAK,SAAS,GAAI;AAEjB,WAAK,OAAO,OACV,MAAO,KAAK,QAAQ,kBAAmB,EAEvC,IAAK,KAAK,IAAK,MAAO,CAAE;AAAA,IAC3B,OAAO;AAEN,WAAK,OAAO,OAAO,MAAO,KAAK,QAAQ,kBAAmB,EAAE,IAAK,MAAO;AAAA,IACzE;AAAA,EACD;AAAA,EAEA,IAAK,OAAe,aAA6B;AAChD,UAAM,qBAAqB,KAAK,gBAAiB,WAAY;AAE7D,SAAK,OAAO,OAAO,MAAO,KAAK,QAAQ,kBAAmB,EAAE,IAAK,KAAM;AAAA,EACxE;AAAA,EAEA,OAAQ,OAAe,aAA6B;AACnD,UAAM,qBAAqB,KAAK,gBAAiB,WAAY;AAC7D,SAAK,QAAS,OAAO,kBAAmB;AAAA,EACzC;AAAA,EAEA,UAAW,WAAmB,aAA6B;AAC1D,UAAM,qBAAqB,KAAK,gBAAiB,WAAY;AAC7D,SAAK,QAAU,KAAK,IAAI,IAAI,aAAc,KAAM,kBAAmB;AAAA,EACpE;AACD;AAKA,IAAqB,mBAArB,MAAsC;AAAA,EACrC;AAAA,EAEA;AAAA,EAEA,YAAa,QAAiB;AAC7B,SAAK,SAAS;AACd,SAAK,SAAS;AAAA,EACf;AAAA,EAEA,WAAY,SAAyB;AACpC,WAAO,IAAI,iBAAkB,SAAS,KAAK,MAAO;AAAA,EACnD;AAAA,EAEA,QAAQ;AAAA,EAAC;AACV;;;AC5EO,IAAM,SAAN,MAAa;AAAA,EACnB;AAAA,EAEA;AAAA,EAEA;AAAA,EAEA,YACC,QACA,QACA,SACC;AACD,SAAK,OAAO,QAAQ;AACpB,SAAK,SAAS;AACd,SAAK,SAAS,OAAO,WAAY,OAAQ;AAAA,EAC1C;AAAA,EAEA,UAAW,SAAS,GAAG,SAAwB,CAAC,GAAI;AACnD,QAAK,CAAE,yBAAwB,mBAAqB,EAAE,SAAU,KAAK,IAAuB,GAAI;AAC/F,WAAK,OAAO,UAAW,QAAQ,MAAO;AAAA,IACvC,OAAO;AACN,WAAK,OAAO;AAAA,QACX,2CAA4C,KAAK,IAAK;AAAA,QACtD,EAAE,WAAW,gBAAgB;AAAA,MAC9B;AAAA,IACD;AAAA,EACD;AAAA,EAEA,UAAW,SAAS,GAAG,SAAwB,CAAC,GAAI;AACnD,QAAK,KAAK,SAAS,qBAAuB;AACzC,WAAK,OAAO,UAAW,QAAQ,MAAO;AAAA,IACvC,OAAO;AACN,WAAK,OAAO;AAAA,QACX,2CAA4C,KAAK,IAAK;AAAA,QACtD,EAAE,WAAW,gBAAgB;AAAA,MAC9B;AAAA,IACD;AAAA,EACD;AAAA,EAEA,QAAS,OAAe,SAAwB,CAAC,GAAI;AACpD,QAAK,CAAE,6BAA0B,uBAAuB,EAAE,SAAU,KAAK,IAAuB,GAAI;AACnG,WAAK,OAAO,QAAS,OAAO,MAAO;AAAA,IACpC,OAAO;AACN,WAAK,OAAO,MAAO,yCAA0C,KAAK,IAAK,IAAI;AAAA,QAC1E,WAAW;AAAA,MACZ,CAAE;AAAA,IACH;AAAA,EACD;AAAA,EAEA,MAAO,QAAgB,SAAwB,CAAC,GAAI;AACnD,QAAK,KAAK,SAAS,qBAAuB;AACzC,WAAK,OAAO,MAAO,QAAQ,MAAO;AAAA,IACnC,OAAO;AACN,WAAK,OAAO;AAAA,QACX,iDAAkD,KAAK,IAAK;AAAA,QAC5D,EAAE,WAAW,gBAAgB;AAAA,MAC9B;AAAA,IACD;AAAA,EACD;AAAA,EAEA,IAAK,OAAe,SAAwB,CAAC,GAAI;AAChD,QAAK,KAAK,SAAS,qBAAuB;AACzC,WAAK,OAAO,IAAK,OAAO,MAAO;AAAA,IAChC,OAAO;AACN,WAAK,OAAO;AAAA,QACX,iDAAkD,KAAK,IAAK;AAAA,QAC5D,EAAE,WAAW,gBAAgB;AAAA,MAC9B;AAAA,IACD;AAAA,EACD;AAAA,EAEA,OAAQ,OAAe,SAAwB,CAAC,GAAI;AACnD,QAAK,KAAK,SAAS,0BAAwB;AAC1C,WAAK,OAAO,OAAQ,OAAO,MAAO;AAAA,IACnC,OAAO;AACN,WAAK,OAAO,MAAO,wCAAyC,KAAK,IAAK,IAAI;AAAA,QACzE,WAAW;AAAA,MACZ,CAAE;AAAA,IACH;AAAA,EACD;AAAA,EAEA,UAAW,WAAmB,SAAwB,CAAC,GAAI;AAC1D,QAAK,KAAK,SAAS,0BAAwB;AAC1C,WAAK,OAAO,UAAW,WAAW,MAAO;AAAA,IAC1C,OAAO;AACN,WAAK,OAAO;AAAA,QACX,2CAA4C,KAAK,IAAK;AAAA,QACtD,EAAE,WAAW,gBAAgB;AAAA,MAC9B;AAAA,IACD;AAAA,EACD;AACD;;;AC7IO,IAAM,UAAN,MAAc;AAAA,EACpB;AAAA,EAEA;AAAA,EAEA;AAAA,EAEA;AAAA,EAEA;AAAA,EAEA;AAAA,EAEA,YACC,aACA,QACA,SACC;AACD,SAAK,UAAU;AACf,SAAK,SAAS;AACd,SAAK,QAAQ,oBAAI,IAAI;AACrB,SAAK,cAAc;AACnB,QAAK,CAAC,WAAW,WAAW,QAAQ,SAAS,cAAe;AAC3D,WAAK,SAAS,IAAI;AAAA,QACjB,KAAK;AAAA,MACN;AACA,WAAK,aAAa,KAAK,OAAO;AAC9B;AAAA,IACD;AACA,WAAO;AAAA,MACN,4BAA6B,QAAQ,QAAQ,WAAY;AAAA,IAC1D;AAAA,EACD;AAAA,EAEA,iBAAiB;AAChB,WAAO,KAAK;AAAA,EACb;AAAA;AAAA;AAAA;AAAA,EAKA,kBAAkB;AACjB,QAAK,QAAQ,IAAI,kCAAkC,SAAU;AAC5D,aAAO;AAAA,IACR;AACA,WAAO,EAAE,SAAS,KAAK,YAAY;AAAA,EACpC;AAAA;AAAA;AAAA;AAAA,EAKA,cAAc;AACb,WAAO,KAAK;AAAA,EACb;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQA,WAAY,SAAyB;AACpC,QAAI,SAAS,KAAK,MAAM,IAAK,QAAQ,IAAK;AAC1C,QAAK,WAAW,QAAY;AAC3B,eAAS,IAAI,OAAQ,KAAK,QAAQ,KAAK,QAAQ,OAAQ;AACvD,WAAK,MAAM,IAAK,QAAQ,MAAM,MAAO;AAAA,IACtC;AACA,WAAO;AAAA,EACR;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQA,aAEC,SACqC;AAjGvC;AAkGE,UAAM,iBAAiB,UAAW,QAAQ,IAAK;AAC/C,QAAI,SAAS,KAAK,WAAW,SAAS,gBAAiB,cAAe;AACtE,QAAK,QAAS;AACb,aAAO;AAAA,IACR;AAEA,QAAI,aAAa,CAAE,cAAe;AAClC,SAAK,aAAQ,WAAR,mBAAgB,OAAQ;AAC5B,mBAAa,WAAW,OAAQ,QAAQ,OAAO,KAAM;AAAA,IACtD;AAEA,aAAS,IAAI,KAAK,WAAY,QAAQ,IAAK,EAAG;AAAA,MAC7C,MAAM;AAAA,MACN,MAAM,QAAQ;AAAA,MACd;AAAA,MACA,SAAS,QAAQ;AAAA,MACjB,aAAa,QAAQ;AAAA,IACtB,CAAE;AAEF,SAAK,WAAW,SAAS,eAAgB,MAAO;AAChD,WAAO;AAAA,EACR;AAAA,EAEA,QAAQ;AACP,SAAK,OAAO,MAAM;AAAA,EACnB;AACD;;;AC5HA,OAAOC,iBAAgB;AACvB,OAAO,UAAU;AAWjB,IAAqB,mBAArB,MAAsC;AAAA,EACrC;AAAA,EAEA;AAAA,EAEA,YAAa,QAAiC,gBAAwC,EAAE,SAAS,kBAAkB,GAAI;AACtH,SAAK,SAAS;AACd,QAAK,KAAK,OAAO,0BAA0B,OAAQ;AAClD,MAAAA,YAAW,sBAAsB;AAAA,IAClC;AACA,IAAAA,YAAW,SAAS,iBAAkB,aAAc;AACpD,SAAK,SAAS,KAAK,aAAc,OAAQ,KAAK,QAAS;AACtD,UAAI,IAAK,MAAMA,YAAW,SAAS,QAAQ,CAAE;AAAA,IAC9C,CAAE;AAAA,EACH;AAAA,EAEA,QAAQ;AACP,SAAK,OAAO,OAAQ,KAAK,OAAO,IAAK;AAAA,EACtC;AAAA,EAEA,MAAM,QAAQ;AACb,IAAAA,YAAW,SAAS,MAAM;AAC1B,SAAK,OAAO,MAAO,CAAE,QAAS;AAC7B,cAAQ,QAAS,GAAI;AAAA,IACtB,CAAE;AAAA,EACH;AACD;;;ACjBO,IAAM,oBAAoB,CAAE,KAAuB,SAAkB,UAAkB,OAAQ;AACrG,QAAM,SAAW,IAAiB,WAAW;AAC7C,EAAE,OAAmB,MAEnB,QAAS,CAAE,gBAAiB,YAAY,QAAQ,cAAc,CAAC,CAAE,EACjE,QAAS,CAAE,gBAAiB;AA1B/B;AA2BG,UAAMC,SAAS,UAAU,QAAM,iBAAY,UAAZ,mBAAmB,KAAK,MAAO,KAC5D,QAAS,QAAQ,KAAM,EACvB,QAAS,OAAO,EAAG,EACnB,QAAS,UAAU,EAAG;AAExB,qDAAa,UAAb,mBAAoB,MAAM,QAAS,CAAE,UAAgB;AACpD,YAAM,cAAc,MAAM;AAC1B,YAAM,SAAS,QAAQ,WAAY;AAAA,QAClC;AAAA,QACA,MAAM;AAAA,QACN,YAAY;AAAA,UACX,MAAM;AAAA,UACN,MAAM;AAAA,UACN,cAAc,QAAQ,gBAAgB;AAAA,UACtC,SAAS,CAAE,MAAM,MAAM,KAAK,KAAK,CAAE;AAAA,QACpC;AAAA,QACA,QAAQ;AAAA,UACP,OAAO,CAAE,QAAQ,UAAU,QAAS;AAAA,UACpC,gBAAgB;AAAA,QACjB;AAAA,MACD,CAAE;AACF,YAAM,SAAS,OACd,KACA,KACA,SACI;AACJ,cAAM,YAAY,KAAK,IAAI;AAC3B,YAAI;AACH,gBAAM,YAAa,KAAK,KAAK,IAAK;AAAA,QACnC,QAAQ;AACP,gBAAM,KAAK;AAAA,QACZ,UAAE;AACD,cAAI,aAAa,IAAI,cAAc;AACnC,cAAK,aAAa,OAAO,aAAa,KAAM;AAC3C,yBAAa;AAAA,UACd;AACA,iBAAO,UAAW,WAAW;AAAA,YAC5BA,SAAQ;AAAA,YACR,IAAI;AAAA,YACJ,WAAW,SAAS;AAAA,UACrB,CAAE;AAAA,QACH;AAAA,MACD;AAAA,IACD;AAAA,EACD,CAAE;AACJ;AAcO,IAAM,+BAA+B,CAC3CA,OAAc,SAAkC,CAAC,MAC7C;AACJ,MAAK,CAACA,OAAO;AACZ,WAAO;AAAA,EACR;AAEA,QAAM,aAAa,CAAE,GAAG,MAAO;AAC/B,QAAM,WAAW,oBAAI,IAAI;AAEzB,SAAOA,MAAK,MAAO,GAAI,EAAE,IAAK,CAAE,YAAa;AAC5C,aAAU,IAAI,GAAG,IAAI,WAAW,QAAQ,KAAM;AAC7C,YAAM,CAAE,KAAK,KAAM,IAAI,WAAY,CAAE;AACrC,UAAK,YAAY,SAAS,CAAC,SAAS,IAAK,GAAI,GAAI;AAChD,iBAAS,IAAK,GAAI;AAClB,eAAO,IAAK,GAAI;AAAA,MACjB;AAAA,IACD;AACA,WAAO;AAAA,EACR,CAAE,EAAE,KAAM,GAAI;AACf;AAqBO,IAAM,6BAA6B,CACzCA,OAAc,WACV;AACJ,QAAM,kBAAkB;AAGxB,EAAAA,QAAOA,MAAK,QAAS,OAAO,EAAG;AAE/B,SAAO,QAAQ,OAAO,MACpB,OAAQ,CAAE,UAAW,MAAM,SAAS,eAAgB;AAGtD,SAAO,IAAK,CAAE,KAAK,KAAK,SAAU;AACjC,QAAK,SAAU,IAAI,IAAK,SAAU,IAAI,IAAK,SAAU,IAAIA,QAAOA;AAChE,SAAK;AAAA,EACN,CAAE;AAGF,QAAM,kBAAkB,OAAO,MAAM,IAAI;AACzC,MAAK,iBAAkB;AACtB,oBAAgB,OAAO;AACvB,WAAO,MAAM,QAAS,eAAgB;AAAA,EACvC;AACD;AAkBO,IAAM,gCAAgC,CAC5C,cAA4B,qBACxB;AAEJ,QAAM,kBAAkB;AAAA,IACvB;AAAA,IACA,MAAM;AAAA,IACN,MAAM;AAAA,IACN,SAAS,CAAE,MAAM,MAAM,KAAK,KAAK,CAAE;AAAA,IACnC,QAAQ;AAAA,MACP,OAAO,CAAE,WAAW,QAAQ,UAAU,QAAS;AAAA,IAChD;AAAA,EACD;AAGA,QAAM,qBAAqB,aACzB,QAAQ,aAAwC,eAAgB;AAClE,eAAa,OAAO,KAAM,sBAAsB,mBAAmB,MAAO;AAC1E,SAAO,CAAE,KAAK,KAAK,SAAU;AAC5B,UAAM,WAAW,mBAAmB,WAAW;AAC/C,UAAM,cAAc,IAAI;AAExB,QAAI,MAAM,IAAK,SAAU;AA9L3B;AAiMG,UAAIA,UAAO,SAAI,UAAJ,mBAAW,SAAQ,IAAI,MAAM,SAAS,MAAM,IAAI,MAAM,OAAO;AAGxE,UAAK,IAAI,SAAU;AAClB,QAAAA,QAAOA,UAAS,MAAM,IAAI,UAAU,IAAI,UAAUA;AAAA,MACnD,WAAY,IAAI,SAAU;AAKzB,QAAAA,QAAO;AAAA,UACN,IAAI,UAAUA;AAAA,UAAM,OAAO,QAAS,IAAI,UAAU,CAAC,CAAE;AAAA,QACtD,EAAE,QAAS,OAAO,EAAG;AAAA,MACtB;AAGA,UAAK,CAACA,SAAQ,CAAC,IAAI,OAAQ;AAC1B,QAAAA,QAAO,IAAI,WAAW;AAAA,MACvB;AAEA,UAAK,kBAAmB;AACvB,QAAAA,QAAOA,MACL,QAAS,QAAQ,KAAM,EACvB,QAAS,OAAO,EAAG,EACnB,QAAS,UAAU,EAAG;AACxB,QAAAA,QAAOA,SAAQ;AAAA,MAChB;AAEA,eAAU;AAAA,QACT,SAAS,aAAa,OAAO;AAAA,QAC7B,MAAMA;AAAA,QACN,QAAQ,IAAI;AAAA,QACZ,QAAQ,IAAI;AAAA,MACb,CAAE;AAEF,kBAAY,MAAO,KAAK,IAAK;AAAA,IAC9B;AAEA,SAAK;AAAA,EACN;AACD;;;ACzOA,SAAS,MAAM,cAAc;AAEtB,IAAM,mBAAmB;AASzB,IAAM,sBAAsB,CAAE,YAAmC;AACvE,QAAM,WAAW,IAAI,QAAS,OAAQ;AACtC,QAAM,aAAa,IAAI,QAAS;AAAA,IAC/B,gBAAgB,SAAS,IAAK,cAAe,KAAK,OAAO;AAAA,EAC1D,CAAE;AACF,GAAE,eAAe,YAAa,EAAE,QAAS,CAAE,QAAS;AACnD,UAAM,QAAQ,SAAS,IAAK,GAAI;AAChC,QAAK,OAAQ;AACZ,iBAAW,IAAK,KAAK,KAAM;AAAA,IAC5B;AAAA,EACD,CAAE;AACF,SAAO;AACR;;;ACvBA;AAAA,EAEC;AAAA,OAIM;AACP,SAAS,MAAMC,eAAc;AAQtB,IAAM,qBAAN,MAAsD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAe5D,OAAQ,SAAkB,SAAkB,QAA8B;AA9B3E;AA+BE,WAAO;AAAA,MACN;AAAA,MACA;AAAA,QACA,uBAAY,WAAY,OAAQ,MAAhC,mBAAmC,SAAU,sBAA7C,mBAAiE,UAASC,QAAO;AAAA,IAClF;AAAA,EACD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAeA,QAAS,SAAkB,SAAkB,QAAiC;AAC7E,UAAM,UAAU,OAAO,IAAK,SAAS,gBAAiB;AACtD,UAAM,iBAAiB,MAAM,QAAS,OAAQ,IAAI,QAAS,CAAE,IAAI;AACjE,QAAK,CAAC,gBAAiB;AACtB,aAAO;AAAA,IACR;AAEA,QAAI,UAAU,YAAY,WAAY,OAAQ,KAAK,YAAY,cAAc;AAC7E,cAAU,QAAQ,SAAU,kBAAkB,EAAE,OAAO,eAAe,CAAE;AAExE,WAAO,YAAY,WAAY,SAAS,OAAQ;AAAA,EACjD;AAAA,EAEA,SAAmB;AAClB,WAAO,CAAE,gBAAiB;AAAA,EAC3B;AACD;;;AT/CA,IAAM,SAAS,IAAK;AAAA;AAAA,EAEnB,MAAO,GAAG,IAAK,EACb,MAAO,+BAAgC,EACvC,QAAS;AAAA,IACT,oBAAoB;AAAA,MACnB,OAAO;AAAA,MACP,UAAU;AAAA,MACV,MAAM;AAAA,MACN,OAAO;AAAA,MACP,QAAQ;AAAA,IACT;AAAA,IACA,eAAe;AAAA,MACd,OAAO;AAAA,MACP,UACM;AAAA,MACN,MAAM;AAAA,MACN,OAAO;AAAA,MACP,QAAQ;AAAA,IACT;AAAA,IACA,QAAQ;AAAA,MACP,OAAO;AAAA,MACP,UACM;AAAA,MACN,MAAM;AAAA,MACN,OAAO;AAAA,MACP,QAAQ;AAAA,IACT;AAAA,EACD,CAAE,EACD,KAAM,GAAI,EACV,MAAO,KAAK,MAAO;AAAA;AAItB,OAAQ,QAAS,QAAQ,IAAK,CAAE,EAAE,UAAU;AAYrC,IAAM,eAAN,MAAM,cAAqD;AAAA,EACjE;AAAA,EAEA;AAAA,EAEA;AAAA,EAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOA,YAAa,QAAoB;AAChC,SAAK,SAAS;AACd,SAAK,SAAS,cAAa,aAAc,MAAO;AAGhD,QAAK,OAAO,mBAAmB,OAAQ;AACtC,aAAO,UAAU,OAAO,QAAS,CAAE;AAAA,IACpC;AAEA,QAAK,OAAO,SAAU;AACrB,WAAK,mBAAmB,cAAa;AAAA,QACpC,OAAO;AAAA,QACP,EAAE,SAAS,OAAO,gBAAgB,kBAAkB;AAAA,MACrD;AAAA,IACD;AACA,SAAK,UAAU,cAAa,cAAe,QAAQ,KAAK,MAAO;AAAA,EAChE;AAAA,EAEA,OAAO,uBAAwB,mBAA4C,eAAwC;AAClH,WAAO,IAAI,iBAAkB,mBAAmB,aAAc;AAAA,EAC/D;AAAA,EAEA,OAAO,aAAc,QAAsC;AAC1D,WAAO;AAAA,MACN,OAAO,gBAAgB;AAAA,MACvB,OAAO;AAAA,IACR;AAAA,EACD;AAAA,EAEA,OAAO,cAAe,QAAqC,QAAyB;AACnF,WAAO,IAAI;AAAA,MACV,OAAO,gBAAgB;AAAA,MACvB;AAAA,MACA,OAAO;AAAA,IACR;AAAA,EACD;AAAA,EAEA,MAAM,WAAW;AAChB,QAAK,KAAK,kBAAmB;AAC5B,YAAM,KAAK,iBAAiB,MAAM;AAAA,IACnC;AAAA,EACD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAUA,aAAa,WACZ,SAIC;AACD,UAAM,aAAa,OAAQ,QAAS,QAAQ,IAAK,CAAE,EAAE,UAAU;AAE/D,QAAI;AACJ,QAAI;AAEJ,SAAK,mCAAS,aAAY,OAAQ;AAEjC,UAAK,WAAW,QAAS;AACxB,cAAM,aAAa,KAAK,MAAO,WAAW,MAAO;AACjD,0BAAkB,WAAW;AAC7B,qBAAa,WAAW;AAAA,MACzB;AAIA,qBAAe,WAAW,eAAc,mCAAS;AAEjD,0BAAoB,WAAW,oBAAmB,mCAAS,qBAAmB,mCAAS;AACvF,UAAK,mBAAmB,CAAC,MAAM,KAAM,eAAgB,GAAI;AAExD,0BAAkB,KAAK;AAAA,UACtB,GAAI,QAAQ,IAAI,CAAE,IAAK,mBAAmB,EAAG;AAAA,QAC9C;AAAA,MACD;AAAA,IACD;AAEA,UAAM,eAAe,MAAM,WAAuB;AAAA,MACjD,MAAM;AAAA,MACN,GAAG;AAAA,MACH,GAAG;AAAA,QACF,KAAK;AAAA,QACL;AAAA,MACD;AAAA,IACD,CAAE;AAEF,WAAO,aAAa;AAAA,EACrB;AACD;AAGA,IAAI;AAYG,IAAM,cAAc,OAC1B,YAI8B;AAC9B,MAAK,cAAc,QAAY;AAC9B,UAAM,eAAe,MAAM,aAAa,WAAe,OAAQ;AAC/D,gBAAY,IAAI,aAAiB,YAAa;AAC9C,SAAK,mCAAS,2BAA0B,SAAS,UAAU,kBAAmB;AAC7E,gBAAU,iBAAiB,MAAM;AAAA,IAClC;AAAA,EACD;AACA,SAAO;AACR;AAEO,IAAM,WAAW,YAAY;AACnC,MAAK,cAAc,QAAY;AAC9B,UAAM,UAAU,SAAS;AACzB,gBAAY;AAAA,EACb;AACD;AAEO,IAAM,UAAU;AAAA,EACtB,0BAA0B;AAAA,EAC1B;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACD;AAEO,IAAM,aAAaC;","names":["Prometheus","Prometheus","path","uuidv1","uuidv1","Prometheus"]}