{"version":3,"sources":["/builds/repos/data-engineering/service-utils/dist/index.js","../src/index.ts","../src/logging/index.ts","../src/logging/wikimedia_ecs.ts","../src/metric/prometheus.ts","../src/metric/metric.ts","../src/metric/index.ts","../src/metric/prometheus_server.ts","../src/express.ts","../src/trace.ts","../src/open_telemetry.ts"],"names":["path","Prometheus"],"mappings":"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","file":"/builds/repos/data-engineering/service-utils/dist/index.js","sourcesContent":[null,"import path from 'node:path';\nimport yargs from 'yargs';\nimport { hideBin } from 'yargs/helpers';\nimport { loadConfig } from 'c12';\n\nimport type winston from 'winston';\nimport {\n\tWinstonLoggerOptions,\n\tcreateWinstonLogger\n} from './logging/index.ts';\n\nimport Prometheus from 'prom-client';\nimport { Metrics, type MetricType } from './metric/index.ts';\nimport type { MetricTypeEnum } from './metric/metric.ts';\nimport PrometheusServer, { PrometheusMetricsConfig } from './metric/prometheus_server.ts';\n\nimport { wrapRouteHandlers, prefixRouterPathMiddleware, responseTimeMetricsMiddleware } from './express.ts';\nimport { extractTraceContext } from './trace.ts';\nimport { XRequestPropagator } from './open_telemetry.ts';\n\nconst _yargs = ( ...args: Parameters<typeof yargs> ) =>\n// Defaults that are described are infered from c12 and not a `default` property\n\tyargs( ...args )\n\t\t.usage( 'Usage: $0 [command] [options]' )\n\t\t.options( {\n\t\t\t'config-directory': {\n\t\t\t\talias: 'd',\n\t\t\t\tdescribe: 'Absolute or relative path of the config file. Defaults to cwd',\n\t\t\t\ttype: 'string',\n\t\t\t\tnargs: 1,\n\t\t\t\tglobal: true\n\t\t\t},\n\t\t\t'config-file': {\n\t\t\t\talias: 'f',\n\t\t\t\tdescribe:\n          'Name of the config file with or without the extension. Defaults to service-utils.config`',\n\t\t\t\ttype: 'string',\n\t\t\t\tnargs: 1,\n\t\t\t\tglobal: true\n\t\t\t},\n\t\t\tconfig: {\n\t\t\t\talias: 'c',\n\t\t\t\tdescribe:\n          'Absolute or relative path of the config file with or without extension. Defaults to ${cwd}/service-utils.config',\n\t\t\t\ttype: 'string',\n\t\t\t\tnargs: 1,\n\t\t\t\tglobal: true\n\t\t\t}\n\t\t} )\n\t\t.help( 'h' )\n\t\t.alias( 'h', 'help' );\n\n// Call function at top level to support --help\n// However, we will call this again in ServiceUtils.loadConfig to support tests\n_yargs( hideBin( process.argv ) ).parseSync();\n\ninterface _Config {\n\tservice_name?: string;\n\tlogging?: WinstonLoggerOptions;\n\tmetrics?: PrometheusMetricsConfig;\n\t[key: string]: any;\n}\n\n// Allow generic typing of arbitrary key/values\ntype Config<T extends Record<string, any>> = _Config & T;\n\nexport class ServiceUtils<T extends Record<string, any> = object> {\n\tconfig: Config<T>;\n\n\tlogger: winston.Logger;\n\n\tmetrics: Metrics;\n\n\tprometheusServer?: PrometheusServer;\n\n\t/**\n\t * Creates the logger, metrics, and prometheus metrics endpoint\n\t *\n\t * @param config\n\t */\n\tconstructor( config: Config<T> ) {\n\t\tthis.config = config;\n\t\tthis.logger = ServiceUtils.createLogger( config );\n\n\t\t// Backwards compatibility for array of metrics config\n\t\tif ( config.metrics instanceof Array ) {\n\t\t\tconfig.metrics = config.metrics[ 0 ];\n\t\t}\n\n\t\tif ( config.metrics ) {\n\t\t\tthis.prometheusServer = ServiceUtils.createPrometheusServer(\n\t\t\t\tconfig.metrics as PrometheusMetricsConfig,\n\t\t\t\t{ service: config.service_name ?? 'default_service' }\n\t\t\t);\n\t\t}\n\t\tthis.metrics = ServiceUtils.createMetrics( config, this.logger );\n\t}\n\n\tstatic createPrometheusServer( prometheus_config: PrometheusMetricsConfig, defaultLabels: Record<string, string> ) {\n\t\treturn new PrometheusServer( prometheus_config, defaultLabels );\n\t}\n\n\tstatic createLogger( config: Config<Record<string, any>> ) {\n\t\treturn createWinstonLogger(\n\t\t\tconfig.service_name ?? 'default_service',\n\t\t\tconfig.logging as WinstonLoggerOptions\n\t\t);\n\t}\n\n\tstatic createMetrics( config: Config<Record<string, any>>, logger: winston.Logger ) {\n\t\treturn new Metrics(\n\t\t\tconfig.service_name ?? 'default_service',\n\t\t\tlogger,\n\t\t\tconfig.metrics\n\t\t);\n\t}\n\n\tasync teardown() {\n\t\tif ( this.prometheusServer ) {\n\t\t\tawait this.prometheusServer.close();\n\t\t}\n\t}\n\n\t/**\n\t * @param {Object=} options c12 loadConfig configuration\n\t * @param {Object=} options.defaultConfig Default config overrideable from yaml\n\t * @param {string=} options.envName Environment-conditional to load\n\t * @param {string=} options.configDirectory Default config directory overrideable in cli. Overrides c12's options.cwd\n\t * @param {string=} options.configFile Name of the config file (without extension) overrideable in cli. Defaults to service-utils.config\n\t * @return\n\t */\n\tstatic async loadConfig<T extends Record<string, any>>(\n\t\toptions?: Parameters<typeof loadConfig<Config<T>>>[0] & {\n\t\t\tuseArgs?: boolean,\n\t\t\tconfigDirectory?: string\n\t\t}\n\t) {\n\t\tconst parsedArgs = _yargs( hideBin( process.argv ) ).parseSync();\n\n\t\tlet configDirectory: string | undefined;\n\t\tlet configFile: string | undefined;\n\n\t\tif ( options?.useArgs !== false ) {\n\t\t\t// -c arg\n\t\t\tif ( parsedArgs.config ) {\n\t\t\t\tconst configPath = path.parse( parsedArgs.config );\n\t\t\t\tconfigDirectory = configPath.dir;\n\t\t\t\tconfigFile = configPath.name;\n\t\t\t}\n\n\t\t\t// TODO: Should these take precedence over -c?\n\t\t\t// -f arg\n\t\t\tconfigFile ??= parsedArgs.configFile ?? options?.configFile;\n\t\t\t// -d arg\n\t\t\tconfigDirectory ??= parsedArgs.configDirectory ?? options?.configDirectory ?? options?.cwd;\n\t\t\tif ( configDirectory && !/^\\//.test( configDirectory ) ) {\n\t\t\t\t// resolve relative paths\n\t\t\t\tconfigDirectory = path.resolve(\n\t\t\t\t\t`${ process.cwd() }/${ configDirectory ?? '' }`\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\tconst loadedConfig = await loadConfig<Config<T>>( {\n\t\t\tname: 'service-utils',\n\t\t\t...options,\n\t\t\t...{\n\t\t\t\tcwd: configDirectory,\n\t\t\t\tconfigFile: configFile\n\t\t\t}\n\t\t} );\n\n\t\treturn loadedConfig.config as Config<T>;\n\t}\n}\n\nexport { MetricType, MetricTypeEnum };\nlet singleton: ServiceUtils | undefined;\n\n/**\n * @param {Object=} options c12 loadConfig configuration\n * @param {Object=} options.defaultConfig Default config overrideable from yaml\n * @param {string=} options.envName Environment-conditional to load\n * @param {string=} options.configDirectory Default config directory overrideable in cli\n * @param {string=} options.configFile Name of the config file (with or without extension) overrideable in cli. Defaults to service-utils.config\n * @param {false=} options.startPrometheusServer Starts Prometheus server if not set to false\n * @param {true=} options.useArgs Use yaml config fetched from cli args to override config if not set to false. Useful for testing.\n * @return {ServiceUtils}\n */\nexport const getInstance = async <T extends Record<string, unknown>>(\n\toptions?: Parameters<typeof loadConfig<Config<T>>>[0] & {\n\t\tstartPrometheusServer?: boolean;\n\t\tuseArgs?: boolean;\n\t}\n): Promise<ServiceUtils<T>> => {\n\tif ( singleton === undefined ) {\n\t\tconst loadedConfig = await ServiceUtils.loadConfig<T>( options );\n\t\tsingleton = new ServiceUtils<T>( loadedConfig );\n\t\tif ( options?.startPrometheusServer !== false && singleton.prometheusServer ) {\n\t\t\tsingleton.prometheusServer.start();\n\t\t}\n\t}\n\treturn singleton as ServiceUtils<T>;\n};\n\nexport const teardown = async () => {\n\tif ( singleton !== undefined ) {\n\t\tawait singleton.teardown();\n\t\tsingleton = undefined;\n\t}\n};\n\nexport const helpers = {\n\twrapExpressRouteHandlers: wrapRouteHandlers,\n\tprefixRouterPathMiddleware,\n\textractTraceContext,\n\tresponseTimeMetricsMiddleware,\n\tXRequestPropagator\n};\n\nexport const prometheus = Prometheus;\n","import winston from 'winston';\nimport { ecsFields, ecsStringify } from '@elastic/ecs-winston-format';\nimport { wikimediaEcsFormatMiddleware } from './wikimedia_ecs.ts';\n\n// npm default log levels, with additional ones to support bunyan.\n// 'trace' and 'fatal' are from bunyan and not natively supported by winston.\n// If these are used, they are shifted to the nearest supported log level\nconst logLevels = {\n\tfatal: 0,\n\terror: 0,\n\twarn: 1,\n\tinfo: 2,\n\thttp: 3,\n\tverbose: 4,\n\tdebug: 5,\n\ttrace: 5,\n\tsilly: 6\n};\n\nexport type Level = keyof typeof logLevels;\n\n/**\n * Configurable and serializable Winston logger options\n * to be derived into its associated objects with {@link createWinstonLogger}\n */\nexport interface WinstonLoggerOptions {\n\tlevel?: Level;\n\tstacktrace?: boolean;\n\tformat?: keyof typeof winston.format | 'ecs';\n\tformatOptions?: any;\n\ttransports?: Array<{\n\t\ttransport: 'File' | 'Console' | 'Http' | 'Stream';\n\t\toptions?: {\n\t\t\tformat?: keyof typeof winston.format | 'ecs';\n\t\t\t[key: string]: any;\n\t\t};\n\t}>;\n\tdefaultMeta?: { [key: string]: any; };\n}\n\n/**\n * @param serviceName Name of the service. Added to default metadata of the logger.\n * @param options {@link WinstonLoggerOptions}, not to be confused with {@link winston.LoggerOptions}\n * @return\n */\nexport const createWinstonLogger = (\n\tserviceName: string,\n\toptions: WinstonLoggerOptions = {}\n) => {\n\t// Uses spread operator to fill options\n\t// with defaults first and then override with config\n\toptions = {\n\t\t...{\n\t\t\tlevel: 'info',\n\t\t\tstacktrace: true,\n\t\t\tformat: 'ecs',\n\t\t\ttransports: [ { transport: 'Console' } ]\n\t\t},\n\t\t...options\n\t};\n\n\tconst ecsFormatter = [\n\t\tecsFields( { convertReqRes: true, ...options.formatOptions } ),\n\t\twikimediaEcsFormatMiddleware(),\n\t\tecsStringify()\n\t];\n\n\treturn winston.createLogger( {\n\t\tlevels: logLevels,\n\t\tlevel: options.level,\n\t\tformat: winston.format.combine(\n\t\t\t...[// Enable stacktrace for errors\n\t\t\t\twinston.format.errors( { stack: options.stacktrace } ),\n\t\t\t\toptions.format === 'ecs' ?\n\t\t\t\t\tecsFormatter :\n\t\t\t\t\twinston.format[ options.format ?? 'json' ](\n\t\t\t\t\t\toptions.format ? options.formatOptions : undefined\n\t\t\t\t\t) ].flat()\n\t\t),\n\t\tdefaultMeta: {\n\t\t\tservice: {\n\t\t\t\tname: serviceName\n\t\t\t},\n\t\t\t...options.defaultMeta\n\t\t},\n\t\ttransports: ( options.transports ?? [] ).map(\n\t\t\t( { transport, options: transportOptions } ) =>\n\t\t\t// @ts-ignore\n\t\t\t\tnew winston.transports[ transport ]( {\n\t\t\t\t\t...transportOptions,\n\t\t\t\t\t// Spread format seperately so we can add on options as parameters\n\t\t\t\t\t...( transportOptions?.format ?\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tformat: winston.format.combine(\n\t\t\t\t\t\t\t\t...[ winston.format.errors( { stack: options.stacktrace } ),\n\t\t\t\t\t\t\t\t\ttransportOptions.format === 'ecs' ?\n\t\t\t\t\t\t\t\t\t\tecsFormatter :\n\t\t\t\t\t\t\t\t\t\twinston.format[ transportOptions.format ](\n\t\t\t\t\t\t\t\t\t\t\ttransportOptions.formatOptions\n\t\t\t\t\t\t\t\t\t\t) ].flat()\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t} :\n\t\t\t\t\t\t{} )\n\t\t\t\t} )\n\n\t\t)\n\t} );\n};\n","// logform and triple-beam are transitive dependencies of winston\nimport type { TransformableInfo, Format } from 'logform';\nimport { LEVEL, MESSAGE, SPLAT } from 'triple-beam';\n// defu is a transitive dependency of c12\nimport { defu } from 'defu';\n\n// (incomplete) ECS fragments derived from https://docs.wikimedia.org/ecs\n// Only the keys used in the code are listed here.\ninterface Http {\n\trequest?: {\n\t\tbody?: {\n\t\t\tcontent?: unknown\n\t\t},\n\t\tid?: string,\n\t\t[key: string]: unknown\n\t},\n\tresponse?: {\n\t\t[key: string]: unknown\n\t},\n\t[key: string]: unknown\n}\n\ninterface Url {\n\tfull?: string,\n\tpath?: string,\n\tquery?: string,\n\t[key: string]: unknown\n}\n\ninterface Source {\n\tip?: string,\n\tport?: number,\n\t[key: string]: unknown\n}\n\ninterface RequestData {\n\tremoteAddress?: string,\n\tremotePort?: number,\n\turl?: string,\n\tpath?: string,\n\tparams?: string[],\n\t[key: string]: unknown\n}\n\ninterface ResponseData {\n\t[key: string]: unknown\n}\n\n/**\n * A Winston `Format` for converting fields from the legacy bunyan structure\n * that was passed into Winston's ecs formatter into the standard fields\n * that Wikimedia uses.\n * Must be inserted betwwen ecsFields() and ecsStringify().\n *\n * @class {Format}\n * @param {Config} opts\n */\nclass WikimediaEcsFormatMiddleware implements Format {\n\ttransform( info: TransformableInfo ): TransformableInfo {\n\t\t// Process service name transformation\n\t\tconst serviceInfo = this.processServiceName( info );\n\n\t\t// Process HTTP request/response data\n\t\tconst httpInfo = this.processHttpData( serviceInfo );\n\n\t\t// Process request ID\n\t\tconst requestIdInfo = this.processRequestId( httpInfo );\n\n\t\t// Ensure symbols are preserved\n\t\trequestIdInfo[ LEVEL ] = info[ LEVEL ];\n\t\trequestIdInfo[ MESSAGE ] = info[ MESSAGE ];\n\t\trequestIdInfo[ SPLAT ] = info[ SPLAT ];\n\n\t\treturn requestIdInfo;\n\t}\n\n\t/**\n\t * Handles service name transformation from legacy bunyan structure\n\t *\n\t * @param info\n\t */\n\tprivate processServiceName( info: TransformableInfo ): TransformableInfo {\n\t\tif ( !info.serviceName && !( info.service && typeof info.service !== 'object' ) ) {\n\t\t\treturn info;\n\t\t}\n\n\t\tconst serviceName = info.serviceName ?? info.service;\n\t\tconst updatedInfo = { ...info };\n\n\t\tupdatedInfo.service = { name: serviceName };\n\t\tdelete updatedInfo.serviceName;\n\n\t\treturn updatedInfo;\n\t}\n\n\t/**\n\t * Processes HTTP request and response data into ECS format\n\t * See https://github.com/wikimedia/service-template-node/blob/main/lib/util.js#L45\n\t *\n\t * @param info\n\t */\n\tprivate processHttpData( info: TransformableInfo ): TransformableInfo {\n\t\tif ( !info.request && !info.response ) {\n\t\t\treturn info;\n\t\t}\n\n\t\tconst http: Http = {};\n\t\tconst url: Url = {};\n\t\tconst source: Source = {};\n\n\t\tif ( info.request ) {\n\t\t\tconst requestData = info.request as RequestData;\n\n\t\t\t// Extract source information\n\t\t\tsource.ip = requestData.remoteAddress;\n\t\t\tsource.port = requestData.remotePort;\n\n\t\t\t// Extract URL information\n\t\t\turl.full = requestData.url;\n\t\t\t// service-template-node dynamically defines routes\n\t\t\t// which are captured with params[n]\n\t\t\t// https://expressjs.com/en/4x/api.html#req.params\n\t\t\turl.path = requestData.params?.[ 0 ] ?? requestData.path ?? '';\n\n\t\t\t// Clean up request object by removing non-ECS-mapped fields\n\t\t\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\n\t\t\tconst { remoteAddress, remotePort, url: requestUrl, params, ...cleanRequest } = requestData;\n\t\t\thttp.request = cleanRequest;\n\t\t}\n\n\t\tif ( info.response ) {\n\t\t\thttp.response = info.response as ResponseData;\n\t\t}\n\n\t\t// Create updated info object without request/response\n\t\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\n\t\tconst { request, response, ...baseInfo } = info;\n\n\t\t// Merge ECS fields with base info\n\t\treturn defu( baseInfo, {\n\t\t\thttp,\n\t\t\turl,\n\t\t\tsource,\n\t\t\tmessage: baseInfo.message,\n\t\t\tlevel: baseInfo.level\n\t\t} );\n\t}\n\n\t/**\n\t * Handles request ID transformation\n\t *\n\t * @param info\n\t */\n\tprivate processRequestId( info: TransformableInfo ): TransformableInfo {\n\t\tif ( !info.requestId && !info.request_id ) {\n\t\t\treturn info;\n\t\t}\n\n\t\tconst requestId = info.requestId ?? info.request_id;\n\t\tconst http = { request: { id: requestId } };\n\n\t\t// Create updated info object without request ID fields\n\t\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\n\t\tconst { requestId: _, request_id: __, ...baseInfo } = info;\n\n\t\t// Merge request ID with base info\n\t\treturn defu( baseInfo, {\n\t\t\thttp,\n\t\t\tmessage: baseInfo.message,\n\t\t\tlevel: baseInfo.level\n\t\t} );\n\t}\n}\n\nexport const wikimediaEcsFormatMiddleware = () => new WikimediaEcsFormatMiddleware() as Format;\n","import Prometheus from 'prom-client';\nimport type { MetricOptions } from './metric.ts';\nimport type { Metrics } from './index.ts';\nimport type { Logger } from 'winston';\n\n/**\n * Normalizes a prometheus string. Should be used for label\n * and metric names, but is not needed for label values.\n *\n * @param {string} str\n * @return {string}\n */\nexport const normalize = ( str: string ) => String( str )\n\t.replace( /\\W/g, '_' ) // replace non-alphanumerics\n\t.replace( /_+/g, '_' ) // dedupe underscores\n\t.replace( /(^_+|_+$)/g, '' ); // trim leading and trailing underscores\n\n/**\n * @deprecated Use {@link Metrics.createMetric} to use Prometheus directly.\n *\n * Prometheus metrics implementation\n */\nexport class PrometheusMetric {\n\toptions: MetricOptions;\n\n\tclient: typeof Prometheus;\n\n\tstaticLabels: any;\n\n\tmetric: Prometheus.Metric;\n\n\tconstructor( options: MetricOptions, client: typeof Prometheus ) {\n\t\tthis.client = client;\n\t\tthis.options = structuredClone( options );\n\t\tif ( this.options.labels === undefined ) {\n\t\t\tthis.options.labels = { names: [] };\n\t\t}\n\t\tthis.staticLabels = this.options.prometheus.staticLabels || {};\n\n\t\t// Add staticLabel names to list of known label names.\n\t\tObject.keys( this.staticLabels ).forEach( ( labelName ) => {\n\t\t\tthis.options.labels?.names.unshift( labelName );\n\t\t} );\n\t\t// Normalize all the label names.\n\t\tthis.options.labels.names = this.options.labels.names.map( normalize );\n\n\t\tthis.options.prometheus.name = normalize(\n\t\t\tthis.options.prometheus.name\n\t\t);\n\t\tthis.metric = new this.client[ this.options.type ]( {\n\t\t\tname: this.options.prometheus.name,\n\t\t\thelp: this.options.prometheus.help,\n\t\t\tlabelNames: this.options.labels.names,\n\t\t\tbuckets: this.options.prometheus.buckets,\n\t\t\tpercentiles: this.options.prometheus.percentiles\n\t\t} );\n\t}\n\n\t/**\n\t * Gets label values array for this metric\n\t * including both static and dynamic labels merged together.\n\t *\n\t * @param {Array} labelValues\n\t * @return {Array}\n\t */\n\t_getLabelValues( labelValues: Array<string> ) {\n\t\t// make a clone of labelValues.\n\t\tconst updatedLabelValues = [ ...labelValues ];\n\t\t// Add staticLabel values to updatedLabelValues if they aren't already listed.\n\t\tObject.keys( this.staticLabels ).forEach( ( labelName ) => {\n\t\t\tif ( !updatedLabelValues.includes( this.staticLabels[ labelName ] ) ) {\n\t\t\t\tupdatedLabelValues.unshift( this.staticLabels[ labelName ] );\n\t\t\t}\n\t\t} );\n\t\treturn updatedLabelValues;\n\t}\n\n\tincrement( amount: number, labelValues: Array<string> ) {\n\t\tconst updatedLabelValues = this._getLabelValues( labelValues );\n\t\t// @ts-ignore\n\t\tthis.metric.labels.apply( this.metric, updatedLabelValues ).inc( amount );\n\t}\n\n\tdecrement( amount: number, labelValues: Array<string> ) {\n\t\tconst updatedLabelValues = this._getLabelValues( labelValues );\n\t\t// @ts-ignore\n\t\tthis.metric.labels.apply( this.metric, updatedLabelValues ).dec( amount );\n\t}\n\n\tobserve( value: number, labelValues: Array<string> ) {\n\t\tconst updatedLabelValues = this._getLabelValues( labelValues );\n\t\t// @ts-ignore\n\t\tthis.metric.labels.apply( this.metric, updatedLabelValues ).observe( value );\n\t}\n\n\tgauge( amount: number, labelValues: Array<string> ) {\n\t\tconst updatedLabelValues = this._getLabelValues( labelValues );\n\t\tif ( amount < 0 ) {\n\t\t\t// @ts-ignore\n\t\t\tthis.metric.labels\n\t\t\t\t.apply( this.metric, updatedLabelValues )\n\t\t\t// @ts-ignore\n\t\t\t\t.dec( Math.abs( amount ) );\n\t\t} else {\n\t\t\t// @ts-ignore\n\t\t\tthis.metric.labels.apply( this.metric, updatedLabelValues ).inc( amount );\n\t\t}\n\t}\n\n\tset( value: number, labelValues: Array<string> ) {\n\t\tconst updatedLabelValues = this._getLabelValues( labelValues );\n\t\t// @ts-ignore\n\t\tthis.metric.labels.apply( this.metric, updatedLabelValues ).set( value );\n\t}\n\n\ttiming( value: number, labelValues: Array<string> ) {\n\t\tconst updatedLabelValues = this._getLabelValues( labelValues );\n\t\tthis.observe( value, updatedLabelValues );\n\t}\n\n\tendTiming( startTime: number, labelValues: Array<string> ) {\n\t\tconst updatedLabelValues = this._getLabelValues( labelValues );\n\t\tthis.timing( ( Date.now() - startTime ) / 1000, updatedLabelValues );\n\t}\n}\n\n/**\n * @deprecated Use {@link Metrics.createMetric} to use Prometheus directly.\n */\nexport default class PrometheusClient {\n\tlogger: Logger;\n\n\tclient: typeof Prometheus;\n\n\tconstructor( logger: Logger ) {\n\t\tthis.logger = logger;\n\t\tthis.client = Prometheus;\n\t}\n\n\tmakeMetric( options: MetricOptions ) {\n\t\treturn new PrometheusMetric( options, this.client );\n\t}\n\n\tclose() {}\n}\n","/**\n * @deprecated Legacy code from service-runner\n */\nimport type { Logger } from 'winston';\nimport type { Metrics, MetricType } from './index.ts';\nimport PrometheusClient, { PrometheusMetric } from './prometheus.ts';\n\n// types correlate to Prometheus metric types.\nexport enum MetricTypeEnum {\n\tGAUGE = 'Gauge',\n\tHISTOGRAM = 'Histogram',\n\tCOUNTER = 'Counter',\n\tSUMMARY = 'Summary',\n\t// eslint-disable-next-line @typescript-eslint/no-duplicate-enum-values\n\tTIMING = 'Histogram',\n}\n\n/**\n * @deprecated Use {@link Metrics.createMetric} to avoid using this interface.\n *\n * These options are for the specific metric being measured.\n *\n * @example\n * {\n *   type: 'Counter',\n *   name: 'hitcount',\n *   prometheus: {\n *     name: 'hitcount',\n *     help: 'hit count',\n *     staticLabels: {},  // a key-value pair of labels\n *     buckets: [], // https://github.com/siimon/prom-client#histogram\n *     percentiles: [], // https://github.com/siimon/prom-client#summary\n *   },\n *   sampleRate: 1, // default 1 https://github.com/brightcove/hot-shots/blob/v6.3.0/README.md#usage\n *   labels: {\n *     names: [],\n *     labelPosition: 'before',\n *     omitLabelNames: false\n *   }\n * }\n */\nexport interface MetricOptions {\n\ttype: MetricType;\n\t/**\n\t * Metrics are cached by this name, as opposed to makeRawMetrics\n\t * where it's cached by the Prometheus metrics name\n\t */\n\tname: string;\n\tprometheus: {\n\t\tname: string;\n\t\thelp: string;\n\t\tstaticLabels?: Record<string, string>;\n\t\tbuckets?: Array<number>;\n\t\tpercentiles?: Array<number>;\n\t};\n\tsampleRate?: number; // Default 1\n\tlabels?: {\n\t\tnames: Array<string>;\n\t\tlabelPosition?: string;\n\t\tomitLabelNames?: boolean;\n\t};\n}\n\n/**\n * @deprecated Use {@link Metrics.createMetric} to use Prometheus directly.\n *\n * This class is a wrapper to call metrics functions\n */\nexport class Metric {\n\ttype: MetricType;\n\n\tmetric: PrometheusMetric;\n\n\tlogger: Logger;\n\n\tconstructor(\n\t\tclient: PrometheusClient,\n\t\tlogger: Logger,\n\t\toptions: MetricOptions\n\t) {\n\t\tthis.type = options.type;\n\t\tthis.logger = logger;\n\t\tthis.metric = client.makeMetric( options );\n\t}\n\n\tincrement( amount = 1, labels: Array<string> = [] ) {\n\t\tif ( [ MetricTypeEnum.COUNTER, MetricTypeEnum.GAUGE ].includes( this.type as MetricTypeEnum ) ) {\n\t\t\tthis.metric.increment( amount, labels );\n\t\t} else {\n\t\t\tthis.logger.error(\n\t\t\t\t`increment() unsupported for metric type ${ this.type }`,\n\t\t\t\t{ levelPath: 'error/metrics' }\n\t\t\t);\n\t\t}\n\t}\n\n\tdecrement( amount = 1, labels: Array<string> = [] ) {\n\t\tif ( this.type === MetricTypeEnum.GAUGE ) {\n\t\t\tthis.metric.decrement( amount, labels );\n\t\t} else {\n\t\t\tthis.logger.error(\n\t\t\t\t`decrement() unsupported for metric type ${ this.type }`,\n\t\t\t\t{ levelPath: 'error/metrics' }\n\t\t\t);\n\t\t}\n\t}\n\n\tobserve( value: number, labels: Array<string> = [] ) {\n\t\tif ( [ MetricTypeEnum.HISTOGRAM, MetricTypeEnum.SUMMARY ].includes( this.type as MetricTypeEnum ) ) {\n\t\t\tthis.metric.observe( value, labels );\n\t\t} else {\n\t\t\tthis.logger.error( `observe() unsupported for metric type ${ this.type }`, {\n\t\t\t\tlevelPath: 'error/metrics'\n\t\t\t} );\n\t\t}\n\t}\n\n\tgauge( amount: number, labels: Array<string> = [] ) {\n\t\tif ( this.type === MetricTypeEnum.GAUGE ) {\n\t\t\tthis.metric.gauge( amount, labels );\n\t\t} else {\n\t\t\tthis.logger.error(\n\t\t\t\t`set() or unique() unsupported for metric type ${ this.type }`,\n\t\t\t\t{ levelPath: 'error/metrics' }\n\t\t\t);\n\t\t}\n\t}\n\n\tset( value: number, labels: Array<string> = [] ) {\n\t\tif ( this.type === MetricTypeEnum.GAUGE ) {\n\t\t\tthis.metric.set( value, labels );\n\t\t} else {\n\t\t\tthis.logger.error(\n\t\t\t\t`set() or unique() unsupported for metric type ${ this.type }`,\n\t\t\t\t{ levelPath: 'error/metrics' }\n\t\t\t);\n\t\t}\n\t}\n\n\ttiming( value: number, labels: Array<string> = [] ) {\n\t\tif ( this.type === MetricTypeEnum.TIMING ) {\n\t\t\tthis.metric.timing( value, labels );\n\t\t} else {\n\t\t\tthis.logger.error( `timing() unsupported for metric type ${ this.type }`, {\n\t\t\t\tlevelPath: 'error/metrics'\n\t\t\t} );\n\t\t}\n\t}\n\n\tendTiming( startTime: number, labels: Array<string> = [] ) {\n\t\tif ( this.type === MetricTypeEnum.TIMING ) {\n\t\t\tthis.metric.endTiming( startTime, labels );\n\t\t} else {\n\t\t\tthis.logger.error(\n\t\t\t\t`endTiming() unsupported for metric type ${ this.type }`,\n\t\t\t\t{ levelPath: 'error/metrics' }\n\t\t\t);\n\t\t}\n\t}\n}\n","import type Prometheus from 'prom-client';\nimport PrometheusClient, { normalize } from './prometheus.ts';\nimport { Metric, type MetricOptions, type MetricTypeEnum } from './metric.ts';\nimport type { PrometheusMetricsConfig } from './prometheus_server.ts';\nimport type { Logger } from 'winston';\n\nexport type MetricType = MetricTypeEnum | `${ MetricTypeEnum }`;\n\ntype GenericPrometheusMetricsConfig<T extends MetricType> =\n\tConstructorParameters<typeof Prometheus[T]>[0];\n\ntype RawMetricOptions<T extends MetricType> =\n\tGenericPrometheusMetricsConfig<T>\n\t& {\n\t\ttype: T,\n\t\t[key: string]: any\n\t};\n\nexport class Metrics {\n\toptions: PrometheusMetricsConfig | undefined;\n\n\tclient: PrometheusClient;\n\n\tprometheus: typeof Prometheus;\n\n\tserviceName: string;\n\n\tcache: Map<string, Metric>;\n\n\tlogger: Logger;\n\n\tconstructor(\n\t\tserviceName: string,\n\t\tlogger: Logger,\n\t\toptions?: PrometheusMetricsConfig\n\t) {\n\t\tthis.options = options;\n\t\tthis.logger = logger;\n\t\tthis.cache = new Map();\n\t\tthis.serviceName = serviceName;\n\t\tif ( !options || options && options.type === 'prometheus' ) {\n\t\t\tthis.client = new PrometheusClient(\n\t\t\t\tthis.logger\n\t\t\t);\n\t\t\tthis.prometheus = this.client.client;\n\t\t\treturn;\n\t\t}\n\t\tlogger.error(\n\t\t\t`No such metrics client: '${ options.type ?? 'undefined' }'`\n\t\t);\n\t}\n\n\tgetServiceName() {\n\t\treturn this.serviceName;\n\t}\n\n\t// T247820: Selectively disable service label based on environment variable.\n\t// Intended for production use case where the service label will be set\n\t// by the Prometheus server.\n\tgetServiceLabel() {\n\t\tif ( process.env.METRICS_SERVICE_LABEL_ENABLED === 'false' ) {\n\t\t\treturn undefined;\n\t\t}\n\t\treturn { service: this.serviceName };\n\t}\n\n\t/**\n\t * @deprecated Remnant from service-runner. Use Prometheus directly.\n\t */\n\tfetchClient() {\n\t\treturn this.client;\n\t}\n\n\t/**\n\t * @deprecated Use {@link createMetric} for new projects.\n\t *\n\t * @param options\n\t * @return\n\t */\n\tmakeMetric( options: MetricOptions ) {\n\t\tlet metric = this.cache.get( options.name );\n\t\tif ( metric === undefined ) {\n\t\t\tmetric = new Metric( this.client, this.logger, options );\n\t\t\tthis.cache.set( options.name, metric );\n\t\t}\n\t\treturn metric;\n\t}\n\n\t/**\n\t * Makes and returns a raw Prometheus Metric bypassing the service-runner wrapper.\n\t *\n\t * @param options\n\t * @return\n\t */\n\tcreateMetric<T extends MetricType>(\n\t\t// Dynamically types the options to be the metrics options for Prometheus\n\t\toptions: RawMetricOptions<T>\n\t): InstanceType<typeof Prometheus[T]> {\n\t\tconst normalisedName = normalize( options.name );\n\t\tlet metric = this.prometheus.register.getSingleMetric( normalisedName );\n\t\tif ( metric ) {\n\t\t\treturn metric as InstanceType<typeof Prometheus[T]>;\n\t\t}\n\n\t\tlet labelNames = [ normalisedName ];\n\t\tif ( options.labels?.names ) {\n\t\t\tlabelNames = labelNames.concat( options.labels.names );\n\t\t}\n\n\t\tmetric = new this.prometheus[ options.type ]( {\n\t\t\tname: normalisedName,\n\t\t\thelp: options.help,\n\t\t\tlabelNames,\n\t\t\tbuckets: options.buckets,\n\t\t\tpercentiles: options.percentiles\n\t\t} );\n\n\t\tthis.prometheus.register.registerMetric( metric );\n\t\treturn metric as InstanceType<typeof Prometheus[T]>;\n\t}\n\n\tclose() {\n\t\tthis.client.close();\n\t}\n}\n","import Prometheus from 'prom-client';\nimport HTTP from 'http';\n\n// This is used for Prometheus Client and Server\nexport interface PrometheusMetricsConfig {\n\ttype: 'prometheus'; // TODO: Remove. Prometheus is the only supported type.\n\tport: number;\n\tname?: string; // TODO: Remove. Unused, from service-runner.\n\tcollectDefaultMetrics?: boolean;\n}\n\n// Builds up an HTTP endpoint per Prometheus config\nexport default class PrometheusServer {\n\tconfig: PrometheusMetricsConfig;\n\n\tserver: HTTP.Server;\n\n\tconstructor( config: PrometheusMetricsConfig, defaultLabels: Record<string, string> = { service: 'default_service' } ) {\n\t\tthis.config = config;\n\t\tif ( this.config.collectDefaultMetrics !== false ) {\n\t\t\tPrometheus.collectDefaultMetrics();\n\t\t}\n\t\tPrometheus.register.setDefaultLabels( defaultLabels );\n\t\tthis.server = HTTP.createServer( async ( req, res ) => {\n\t\t\tres.end( await Prometheus.register.metrics() );\n\t\t} );\n\t}\n\n\tstart() {\n\t\tthis.server.listen( this.config.port );\n\t}\n\n\tasync close() {\n\t\tPrometheus.register.clear();\n\t\tthis.server.close( ( err ) => {\n\t\t\tPromise.resolve( err );\n\t\t} );\n\t}\n}\n","import type { NextFunction, Request as ExpressRequest, Response as ExpressResponse, Express, Router } from 'express';\nimport type { Metrics } from './metric/index.ts';\nimport { MetricTypeEnum } from './metric/metric.ts';\nimport { type ServiceUtils } from './index.ts';\n\n/**\n * @deprecated Use {@link responseTimeMetricsMiddleware} for new projects.\n *\n * Adapted from service-template-node.\n * https://github.com/wikimedia/service-template-node/blob/main/lib/util.js\n *\n * Awaits all of the given router's handler functions\n * inside a try/catch block so as to allow catching all errors,\n * regardless of whether a handler is async or not.\n *\n * If registering routes with sub-routers\n *\n * @param {Express} app the Express application or the Router itself\n * @param {Metrics} metrics the metrics object\n * @param {string} subPath the subpath from the main express router, if applicable\n */\nexport const wrapRouteHandlers = ( app: Express | Router, metrics: Metrics, subPath: string = '' ) => {\n\tconst router = ( app as Express )._router ?? app;\n\t( router as Router ).stack\n\t\t// Ignore built-in routes (they have route:null in the stack)\n\t\t.flatMap( ( routerLayer ) => routerLayer.route ? routerLayer : [] )\n\t\t.forEach( ( routerLayer ) => {\n\t\t\tconst path = ( subPath + '/' + routerLayer.route?.path.slice( 1 ) )\n\t\t\t\t.replace( /\\/:/g, '/--' )\n\t\t\t\t.replace( /^\\//, '' )\n\t\t\t\t.replace( /[/?]+$/, '' );\n\n\t\t\trouterLayer?.route?.stack.forEach( ( layer: any ) => {\n\t\t\t\tconst origHandler = layer.handle;\n\t\t\t\tconst metric = metrics.makeMetric( {\n\t\t\t\t\ttype: MetricTypeEnum.HISTOGRAM,\n\t\t\t\t\tname: 'router',\n\t\t\t\t\tprometheus: {\n\t\t\t\t\t\tname: 'express_router_request_duration_seconds',\n\t\t\t\t\t\thelp: 'request duration handled by router in seconds',\n\t\t\t\t\t\tstaticLabels: metrics.getServiceLabel(),\n\t\t\t\t\t\tbuckets: [ 0.01, 0.05, 0.1, 0.3, 1 ]\n\t\t\t\t\t},\n\t\t\t\t\tlabels: {\n\t\t\t\t\t\tnames: [ 'path', 'method', 'status' ],\n\t\t\t\t\t\tomitLabelNames: true\n\t\t\t\t\t}\n\t\t\t\t} );\n\t\t\t\tlayer.handle = async (\n\t\t\t\t\treq: ExpressRequest,\n\t\t\t\t\tres: ExpressResponse,\n\t\t\t\t\tnext: NextFunction\n\t\t\t\t) => {\n\t\t\t\t\tconst startTime = Date.now();\n\t\t\t\t\ttry {\n\t\t\t\t\t\tawait origHandler( req, res, next );\n\t\t\t\t\t} catch {\n\t\t\t\t\t\tawait next();\n\t\t\t\t\t} finally {\n\t\t\t\t\t\tlet statusCode = res.statusCode || 500;\n\t\t\t\t\t\tif ( statusCode < 100 || statusCode > 599 ) {\n\t\t\t\t\t\t\tstatusCode = 500;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tmetric.endTiming( startTime, [\n\t\t\t\t\t\t\tpath || 'root',\n\t\t\t\t\t\t\treq.method,\n\t\t\t\t\t\t\tstatusCode.toString()\n\t\t\t\t\t\t] );\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t} );\n\t\t} );\n};\n\n/**\n * Reverse map Express parameters to a route.\n *\n * @example\n * // returns '/:id1/2/:id2/4'\n * _replacePathWithPlaceholders('/1/2/3/4', [[\"id1\", \"1\"], [\"id2\", \"3\"]])\n *\n * @param {string} path\n * @param {Array<[string, string]>} params\n *   Ordered array of [paramName, paramValue] pairs to map onto path\n * @return\n */\nexport const _replacePathWithPlaceholders = (\n\tpath: string, params: Array<[string, string]> = []\n) => {\n\tif ( !path ) {\n\t\treturn '';\n\t} // Handle empty path case\n\n\tconst paramQueue = [ ...params ]; // Copy params to process sequentially\n\tconst usedKeys = new Set(); // Ensure each key is used only once per matching value\n\n\treturn path.split( '/' ).map( ( segment ) => {\n\t\tfor ( let i = 0; i < paramQueue.length; i++ ) {\n\t\t\tconst [ key, value ] = paramQueue[ i ];\n\t\t\tif ( segment === value && !usedKeys.has( key ) ) {\n\t\t\t\tusedKeys.add( key ); // Mark key as used\n\t\t\t\treturn `:${ key }`;\n\t\t\t}\n\t\t}\n\t\treturn segment; // Keep unchanged if no match\n\t} ).join( '/' );\n};\n\n/**\n * Use alongside {@link responseTimeMetricsMiddleware} to enable metrics for\n * routes inside sub-routers. If the same sub-router is registered multiple times,\n * it uses the last called path.\n *\n * @example\n * const app = express();\n * app.use( helpers.responseTimeMetricsMiddleware( serviceUtils ) );\n * const subRouter = express.Router();\n *\n * app.get( '/', ( req, res ) => res.end() );\n * subRouter.get( '/', ( req, res ) => res.end() );\n *\n * prefixRouterPathMiddleware('/sub', subRouter);\n * app.use( '/sub', subRouter );\n *\n * @param {string} path path to router\n * @param {Router} router\n */\nexport const prefixRouterPathMiddleware = (\n\tpath: string, router: Router\n) => {\n\tconst MIDDLEWARE_NAME = 'prefixRouterPathMiddleware';\n\n\t// Remove trailing slash if there is one\n\tpath = path.replace( /\\/$/, '' );\n\n\trouter.stack = router.stack\n\t\t.filter( ( layer ) => layer.name !== MIDDLEWARE_NAME );\n\n\t// Register middleware to instantiate a Layer object\n\trouter.use( ( req, res, next ) => {\n\t\treq[ 'subPath' ] = req[ 'subPath' ] ? req[ 'subPath' ] + path : path;\n\t\tnext();\n\t} );\n\n\t// Move middleware to the front so it gets called first\n\tconst middlewareLayer = router.stack.pop();\n\tif ( middlewareLayer ) {\n\t\tmiddlewareLayer.name = MIDDLEWARE_NAME;\n\t\trouter.stack.unshift( middlewareLayer );\n\t}\n};\n\n/**\n * Adapted from cxserver\n * https://github.com/wikimedia/mediawiki-services-cxserver/blob/master/lib/util.js\n *\n * Wraps all routes in response time metrics.\n * The only behavioral change from service-template-node is\n * the original route is kept instead of normalized.\n *\n * To enable metrics for routes inside sub-routers,\n * use alongside {@link prefixRouterPathMiddleware}.\n *\n * @param {ServiceUtils} serviceUtils\n * @param {boolean} legacyPathNaming\n *   Whether to use the path naming conventions from service-template-node\n * @return\n */\nexport const responseTimeMetricsMiddleware = (\n\tserviceUtils: ServiceUtils, legacyPathNaming?: boolean\n) => {\n\t// Create a histogram metric for HTTP request duration\n\tconst requestDuration = {\n\t\ttype: MetricTypeEnum.HISTOGRAM as const,\n\t\tname: 'express_router_request_duration_seconds',\n\t\thelp: 'request duration handled by router in seconds',\n\t\tbuckets: [ 0.01, 0.05, 0.1, 0.3, 1 ],\n\t\tlabels: {\n\t\t\tnames: [ 'service', 'path', 'method', 'status' ]\n\t\t}\n\t};\n\t// Create the metric\n\t// This will return the existing metric if it already exists\n\tconst responseTimeMetric = serviceUtils\n\t\t.metrics.createMetric<MetricTypeEnum.HISTOGRAM>( requestDuration );\n\tserviceUtils.logger.info( 'responseTimeMetric', responseTimeMetric.labels );\n\treturn ( req, res, next ) => {\n\t\tconst endTimer = responseTimeMetric.startTimer();\n\t\tconst originalEnd = res.end;\n\n\t\tres.end = ( ...args ) => {\n\t\t\t// req.route.path is the matched string pattern relative to its local router\n\t\t\t// If there's no match or it's a catch-all, default to '/'\n\t\t\tlet path = req.route?.path && req.route.path !== '*' ? req.route.path : '/';\n\n\t\t\t// Apply subPath if available\n\t\t\tif ( req.subPath ) {\n\t\t\t\tpath = path === '/' ? req.subPath : req.subPath + path;\n\t\t\t} else if ( req.baseUrl ) {\n\t\t\t\t// If there is no subpath (like if the user forgets to register it),\n\t\t\t\t// attempt to reconstruct it.\n\t\t\t\t// This only works for routes that use params and\n\t\t\t\t// with { mergeParams: true } set in options\n\t\t\t\tpath = _replacePathWithPlaceholders(\n\t\t\t\t\treq.baseUrl + path, Object.entries( req.params ?? [] )\n\t\t\t\t).replace( /\\/$/, '' ); // Remove trailing slash if there is one\n\t\t\t}\n\n\t\t\t// Default to subPath or root if no route is matched (i.e. 404)\n\t\t\tif ( !path || !req.route ) {\n\t\t\t\tpath = req.subPath ?? '/';\n\t\t\t}\n\n\t\t\tif ( legacyPathNaming ) {\n\t\t\t\tpath = path\n\t\t\t\t\t.replace( /\\/:/g, '/--' )\n\t\t\t\t\t.replace( /^\\//, '' )\n\t\t\t\t\t.replace( /[/?]+$/, '' );\n\t\t\t\tpath = path || 'root';\n\t\t\t}\n\t\t\t// Observe the duration\n\t\t\tendTimer( {\n\t\t\t\tservice: serviceUtils.config.service_name,\n\t\t\t\tpath: path,\n\t\t\t\tmethod: req.method,\n\t\t\t\tstatus: res.statusCode\n\t\t\t} );\n\t\t\t// Call the original end function\n\t\t\toriginalEnd.apply( res, args );\n\t\t};\n\t\t// Continue processing the request\n\t\tnext();\n\t};\n};\n","import { v1 as uuidv1 } from 'uuid';\n\nexport const X_REQUEST_HEADER = 'x-request-id';\n\n/**\n * Takes headers and extracts any trace headers (x-request-id, traceparent, tracestate)\n * and applies it to new headers.\n *\n * @param {HeadersInit} headers Headers to extract trace from\n * @return {Headers} new headers with trace headers set\n */\nexport const extractTraceContext = ( headers: HeadersInit ): Headers => {\n\tconst _headers = new Headers( headers );\n\tconst newHeaders = new Headers( {\n\t\t'x-request-id': _headers.get( 'x-request-id' ) ?? uuidv1()\n\t} );\n\t[ 'traceparent', 'tracestate' ].forEach( ( key ) => {\n\t\tconst value = _headers.get( key );\n\t\tif ( value ) {\n\t\t\tnewHeaders.set( key, value );\n\t\t}\n\t} );\n\treturn newHeaders;\n};\n","import {\n\tContext,\n\tpropagation,\n\tTextMapGetter,\n\tTextMapPropagator,\n\tTextMapSetter\n} from '@opentelemetry/api';\nimport { v1 as uuidv1 } from 'uuid';\n\nimport { X_REQUEST_HEADER } from './trace.ts';\n\n/**\n * @experimental\n * Propagates `x-request-id` headers. Used with OpenTelemetry.\n */\nexport class XRequestPropagator implements TextMapPropagator {\n\n\t/**\n\t * Injects values from a given `Context` into a carrier.\n\t *\n\t * OpenTelemetry defines a common set of format values (TextMapPropagator),\n\t * and each has an expected `carrier` type.\n\t *\n\t * @param {Context} context the Context from which to extract values to transmit over\n\t *     the wire.\n\t * @param {unknown} carrier the carrier of propagation fields, such as http request\n\t *     headers.\n\t * @param {TextMapSetter} setter an optional {@link TextMapSetter}. If undefined, values will be\n\t *     set by direct object assignment.\n\t */\n\tinject( context: Context, carrier: unknown, setter: TextMapSetter ): void {\n\t\tsetter.set(\n\t\t\tcarrier,\n\t\t\tX_REQUEST_HEADER,\n\t\t\tpropagation.getBaggage( context )?.getEntry( X_REQUEST_HEADER )?.value ?? uuidv1()\n\t\t);\n\t}\n\n\t/**\n\t * Given a `Context` and a carrier, extract context values from a\n\t * carrier and return a new context, created from the old context, with the\n\t * extracted values.\n\t *\n\t * @param {Context} context the Context from which to extract values to transmit over\n\t *     the wire.\n\t * @param {unknown} carrier the carrier of propagation fields, such as http request\n\t *     headers.\n\t * @param {TextMapGetter} getter an optional {@link TextMapGetter}. If undefined,\n\t *     keys will be all own properties, and keys will be accessed by direct object access.\n\t * @return {Context} context\n\t */\n\textract( context: Context, carrier: unknown, getter: TextMapGetter ): Context {\n\t\tconst headers = getter.get( carrier, X_REQUEST_HEADER );\n\t\tconst xRequestHeader = Array.isArray( headers ) ? headers[ 0 ] : headers;\n\t\tif ( !xRequestHeader ) {\n\t\t\treturn context;\n\t\t}\n\n\t\tlet baggage = propagation.getBaggage( context ) ?? propagation.createBaggage();\n\t\tbaggage = baggage.setEntry( X_REQUEST_HEADER, { value: xRequestHeader } );\n\n\t\treturn propagation.setBaggage( context, baggage );\n\t}\n\n\tfields(): string[] {\n\t\treturn [ X_REQUEST_HEADER ];\n\t}\n}\n"]}